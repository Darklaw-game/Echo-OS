<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo OS</title>
    <link rel="icon" href="https://placehold.co/32x32/000000/FFFFFF?text=G" type="image/png"> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%; /* Ensure html and body take full height */
            margin: 0; /* Remove default body margin */
            padding: 0; /* Remove default body padding */
            overflow: hidden; /* Hide scrollbars */
            display: flex; /* Use flexbox for centering */
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif; /* Apply font to body */
            background-color: #1a202c; /* Fallback background color */
        }

        /* Canvas for the dynamic gradient background */
        #backgroundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block; /* Removes extra space below canvas */
            z-index: 0; /* Ensure it's behind other content */
        }

        /* Taskbar specific styles */
        .taskbar {
            backdrop-filter: blur(20px); /* Frosted glass effect */
            background-color: rgba(31, 41, 55, 0.7); /* Slightly transparent dark gray */
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Taskbar icon hover effect */
        .taskbar-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Generic Window Styles (for Chatbot and File Explorer) */
        .os-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748; /* Darker gray for window body */
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            z-index: 100; /* Ensure it's on top */
            overflow: hidden;
            cursor: default;
            resize: both; /* Allow resizing */
            min-width: 300px;
            min-height: 200px;
        }

        .os-window-header {
            background-color: #1a202c; /* Even darker header */
            padding: 12px 16px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            cursor: grab; /* Cursor indicates draggable */
        }

        /* Window control buttons (minimize, maximize, close) */
        .os-window-control-btn {
            color: white;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out;
        }
        .os-window-control-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .os-window-control-btn.close-btn:hover {
            background-color: #ef4444; /* Red for close button on hover */
        }


        .os-window-content {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #2d3748; /* Same as window body */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Chatbot specific styles (inherits from os-window) */
        .chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #2d3748; /* Same as chat window body */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-input-area {
            display: flex;
            padding: 12px 16px;
            background-color: #1a202c; /* Darker input area */
            border-top: 1px solid #4a5568;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .chat-input-area input {
            flex-grow: 1;
            background-color: #4a5568; /* Input field background */
            border: 1px solid #6b7280;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-right: 8px;
            outline: none;
        }

        .chat-input-area button {
            background-color: #4299e1; /* Blue send button */
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }

        .chat-input-area button:hover {
            background-color: #3182ce;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message-user {
            background-color: #4299e1; /* Blue for user messages */
            align-self: flex-end;
            color: white;
        }

        .message-ai {
            background-color: #6b7280; /* Gray for AI messages */
            align-self: flex-start;
            color: white;
        }

        .loading-indicator {
            align-self: flex-start;
            color: #ccc;
            font-style: italic;
        }

        /* Start Menu Styles */
        #startMenu {
            position: absolute;
            bottom: 70px; /* Above the taskbar */
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background-color: rgba(31, 41, 55, 0.9); /* Slightly transparent dark gray */
            backdrop-filter: blur(15px);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            padding: 10px;
            display: flex; /* Changed from 'hidden' class to 'display: flex' for JS control */
            flex-direction: column;
            z-index: 101; /* Above taskbar, below app windows */
        }

        .start-menu-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: white;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .start-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .start-menu-item svg {
            margin-right: 10px;
        }

        /* Start Menu Search Bar */
        .start-menu-search-area {
            padding: 10px 15px;
            border-bottom: 1px solid #4a5568;
            margin-bottom: 10px;
        }
        .start-menu-search-area input {
            width: 100%;
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            outline: none;
        }
        .start-menu-search-area button {
            margin-top: 8px;
            background-color: #4299e1;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
        }
        .start-menu-search-area button:hover {
            background-color: #3182ce;
        }

        .start-menu-search-results {
            margin-top: 10px;
            max-height: 150px; /* Limit height for scrollability */
            overflow-y: auto;
            border-top: 1px solid #4a5568;
            padding-top: 10px;
        }
        .start-menu-search-results .result-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out;
        }
        .start-menu-search-results .result-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .start-menu-search-results .result-item svg {
            margin-right: 8px;
        }


        /* File Explorer Specific Styles */
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease-in-out;
        }

        .file-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .file-item svg {
            margin-right: 8px;
        }

        /* Desktop Area and Icons */
        #desktopArea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px); /* Adjust for taskbar height */
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start; /* Align items to the top */
            gap: 10px; /* Spacing between icons */
        }

        .desktop-icon {
            width: 80px; /* Standard icon width */
            height: 90px; /* Standard icon height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            border-radius: 8px;
            padding: 5px;
            transition: background-color 0.1s ease-in-out;
            user-select: none; /* Prevent text selection on drag */
            position: absolute; /* Allows dragging and custom positioning */
        }

        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .desktop-icon svg {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        /* Context Menu Styles */
        #contextMenu {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            padding: 5px 0;
            z-index: 200; /* Above all other UI elements */
            min-width: 180px;
            display: none; /* Hidden by default */
        }

        .context-menu-item {
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
        }

        .context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* App Store Specific Styles */
        .app-store-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: #1a202c;
            border-radius: 8px;
            margin-bottom: 8px;
            color: white;
        }
        .app-store-item-info {
            display: flex;
            align-items: center;
        }
        .app-store-item-info svg {
            margin-right: 12px;
        }
        .app-store-item-info div {
            display: flex;
            flex-direction: column;
        }
        .app-store-item-info .app-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .app-store-item-info .app-description {
            font-size: 0.85rem;
            color: #a0aec0;
        }
        .app-store-item button {
            background-color: #4299e1;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .app-store-item button:hover {
            background-color: #3182ce;
        }
        .app-store-item button:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }

        /* Iframe styles for apps */
        .iframe-app-content {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Echo Browser specific styles */
        .browser-address-bar {
            display: flex;
            padding: 12px 16px;
            background-color: #1a202c;
            border-bottom: 1px solid #4a5568;
            align-items: center;
        }
        .browser-address-bar input {
            flex-grow: 1;
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-right: 8px;
            outline: none;
        }
        .browser-address-bar button {
            background-color: #4299e1;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .browser-address-bar button:hover {
            background-color: #3182ce;
        }

        /* Tab Manager specific styles */
        .tab-manager-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tab-manager-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #1a202c;
            border-radius: 8px;
            color: white;
        }

        .tab-manager-item-info {
            display: flex;
            align-items: center;
        }

        .tab-manager-item-info svg {
            margin-right: 10px;
        }

        .tab-manager-item button {
            background-color: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }

        .tab-manager-item button:hover {
            background-color: #dc2626;
        }

        .tab-manager-virus-controls {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #4a5568;
        }

        .tab-manager-virus-controls button {
            width: 100%;
            background-color: #f59e0b;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }

        .tab-manager-virus-controls button:hover {
            background-color: #d97706;
        }

        /* AI Photo Gen specific styles */
        .ai-photo-gen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px;
            flex-grow: 1;
        }

        .ai-photo-gen-input-area {
            display: flex;
            width: 100%;
            gap: 8px;
        }

        .ai-photo-gen-input-area input {
            flex-grow: 1;
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            outline: none;
        }

        .ai-photo-gen-input-area button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }

        .ai-photo-gen-input-area button:hover {
            background-color: #3182ce;
        }

        .ai-photo-gen-image-display {
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a202c;
            border-radius: 8px;
            overflow: hidden;
            position: relative; /* For loading indicator positioning */
        }

        .ai-photo-gen-image-display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .ai-photo-gen-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #a0aec0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-photo-gen-loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Password Game specific styles */
        .password-game-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            flex-grow: 1;
            align-items: center;
        }

        .password-game-rules {
            background-color: #1a202c;
            border-radius: 8px;
            padding: 16px;
            color: white;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .password-game-rules h3 {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .password-game-rules ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .password-game-rules li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            font-size: 0.95rem;
        }

        .password-game-rules li svg {
            margin-right: 8px;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }

        .password-input-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 500px;
        }

        .password-input-area input {
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            outline: none;
            font-size: 1.1rem;
        }

        .password-input-area button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }

        .password-input-area button:hover {
            background-color: #3182ce;
        }

        .password-feedback-area {
            background-color: #1a202c;
            border-radius: 8px;
            padding: 16px;
            color: white;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .password-feedback-area ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .password-feedback-area li {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .password-feedback-area li.pass {
            color: #48bb78; /* Green for pass */
        }

        .password-feedback-area li.fail {
            color: #f56565; /* Red for fail */
        }

        .password-feedback-area li svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* Spend Money App specific styles */
        .spend-money-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            flex-grow: 1;
            align-items: center;
        }

        .spend-money-balance {
            font-size: 1.8rem;
            font-weight: 700;
            color: #48bb78; /* Green for money */
            margin-bottom: 16px;
            text-align: center;
            width: 100%;
        }

        .spend-money-section {
            background-color: #1a202c;
            border-radius: 8px;
            padding: 16px;
            color: white;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .spend-money-section h3 {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .spend-money-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .spend-money-input-group input {
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            outline: none;
            font-size: 1rem;
        }

        .spend-money-section button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
        }

        .spend-money-section button:hover {
            background-color: #3182ce;
        }

        .spend-money-transactions {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid #4a5568;
            padding-top: 12px;
            margin-top: 12px;
        }

        .spend-money-transactions li {
            font-size: 0.9rem;
            color: #a0aec0;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .spend-money-transactions li.buy {
            color: #f56565; /* Red for purchases */
        }

        .spend-money-transactions li.earn {
            color: #48bb78; /* Green for earnings */
        }

        /* Drawing Game Styles */
        .drawing-game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
            flex-grow: 1;
        }
        #drawingCanvas {
            border: 2px solid #4a5568;
            background-color: #f0f0f0; /* White canvas background */
            cursor: crosshair;
            touch-action: none; /* Prevent scrolling/zooming on touch */
        }
        .drawing-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
            padding: 8px;
            background-color: #1a202c;
            border-radius: 8px;
        }
        .drawing-controls input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
            padding: 0;
        }
        .drawing-controls input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .drawing-controls input[type="color"]::-webkit-color-swatch {
            border: 2px solid #6b7280;
            border-radius: 6px;
        }
        .drawing-controls input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }
        .drawing-controls input[type="color"]::-moz-color-swatch {
            border: 2px solid #6b7280;
            border-radius: 6px;
        }
        .drawing-controls input[type="range"] {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4a5568;
            outline: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .drawing-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4299e1;
            border-radius: 50%;
            cursor: grab;
            margin-top: -5px; /* Adjust to center thumb vertically */
        }
        .drawing-controls button {
            background-color: #4299e1;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .drawing-controls button:hover {
            background-color: #3182ce;
        }

        /* Stimulation Clicker Styles */
        .stimulation-clicker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            flex-grow: 1;
            justify-content: center;
        }
        #stimulationDisplay {
            font-size: 2.5rem;
            font-weight: 700;
            color: #a0aec0;
            text-shadow: 0 0 10px rgba(160, 174, 192, 0.5);
            margin-bottom: 20px;
        }
        #mainClickButton {
            background-color: #4299e1;
            color: white;
            padding: 20px 40px;
            border-radius: 50%; /* Circular button */
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            outline: none;
            transform: scale(1);
        }
        #mainClickButton:hover {
            background-color: #3182ce;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.6);
        }
        #mainClickButton:active {
            transform: scale(0.95);
        }
        .upgrades-section {
            background-color: #1a202c;
            border-radius: 8px;
            padding: 15px;
            color: white;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .upgrades-section h3 {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            text-align: center;
        }
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #2d3748;
            border-radius: 6px;
        }
        .upgrade-item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .upgrade-item-name {
            font-weight: 500;
            font-size: 0.95rem;
        }
        .upgrade-item-cost {
            font-size: 0.8rem;
            color: #cbd5e0;
        }
        .upgrade-item button {
            background-color: #48bb78;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .upgrade-item button:hover {
            background-color: #38a169;
        }
        .upgrade-item button:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }
        #chaosVisuals {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
            overflow: hidden;
            z-index: -1; /* Behind other content */
        }
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            opacity: 0;
            animation: fadeOutAndShrink 1s forwards;
        }
        @keyframes fadeOutAndShrink {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0); opacity: 0; }
        }

        /* Hacker Simulator Styles */
        .hacker-simulator-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
            background-color: #0d1a26; /* Dark background for the app */
            overflow: hidden; /* Hide overflowing binary */
            color: #0f0; /* Green text for hacker style */
            font-family: 'monospace', 'Courier New', Courier; /* Monospace font */
        }

        #binaryBackgroundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Behind content, but above window background */
            opacity: 0.2; /* Slightly transparent */
        }

        .hacker-content {
            position: relative;
            z-index: 2; /* Above binary background */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 600px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent overlay */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); /* Green glow */
            border: 1px solid #0f0;
        }

        .hacker-content h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0f0;
            text-shadow: 0 0 8px #0f0;
            margin-bottom: 10px;
        }

        .hacker-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .hacker-input-group label {
            font-size: 1rem;
            color: #0f0;
        }

        .hacker-input-group input {
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 14px;
            border-radius: 6px;
            outline: none;
            font-size: 1.1rem;
            font-family: 'monospace', 'Courier New', Courier;
        }

        .hacker-input-group button {
            background-color: #0a0; /* Darker green button */
            color: #000; /* Black text for contrast */
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .hacker-input-group button:hover {
            background-color: #0c0; /* Lighter green on hover */
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.7);
        }

        .hacker-output-area {
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            width: 100%;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
            font-family: 'monospace', 'Courier New', Courier;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .hacker-output-area span.success { color: #0f0; }
        .hacker-output-area span.error { color: #f00; }
        .hacker-output-area span.info { color: #0ff; } /* Cyan for info */


        /* Dark App Store specific styles */
        #darkAppStoreContent {
            background-color: #0d1a26; /* Darker background for dark store */
            color: #0f0; /* Green text */
        }
        #darkAppStoreContent h3 {
            color: #0f0; /* Green headers */
            text-shadow: 0 0 5px #0f0;
        }
        #darkAppStoreContent .app-store-item {
            background-color: #1a202c; /* Slightly lighter than background */
            border: 1px solid #0f0; /* Green border */
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3); /* Green glow */
        }
        #darkAppStoreContent .app-store-item-info .app-name {
            color: #0f0; /* Green app names */
        }
        #darkAppStoreContent .app-store-item-info .app-description {
            color: #90ee90; /* Lighter green for description */
        }
        #darkAppStoreContent .app-store-item button {
            background-color: #0a0; /* Green button */
            color: #000; /* Black text on button */
        }
        #darkAppStoreContent .app-store-item button:hover {
            background-color: #0c0;
        }
        #darkAppStoreContent .app-store-item button:disabled {
            background-color: #4a5568;
            color: #a0aec0;
        }

        /* Echo Browser specific styles for dark mode button */
        #darknessButtonContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            background-color: #0d1a26; /* Dark background for darkness page */
            color: #0f0;
            font-family: 'monospace', 'Courier New', Courier;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 20px;
        }
        #darknessButton {
            background-color: #0a0; /* Green button */
            color: #000;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            border: 2px solid #0f0;
        }
        #darknessButton:hover {
            background-color: #0c0;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
            transform: scale(1.05);
        }

    </style>
</head>
<body class="antialiased">

    <canvas id="backgroundCanvas"></canvas>

    <div id="loginContainer" class="z-10 bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700 relative">
        <h2 class="text-3xl font-bold text-white text-center mb-6">Welcome to Echo OS</h2>
        <p class="text-gray-400 text-center mb-8">Please log in to continue.</p>

        <form id="loginForm" class="space-y-6">
            <div>
                <label for="username" class="block text-gray-300 text-sm font-medium mb-2">Username</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter your username"
                    required
                >
            </div>
            <div>
                <label for="password" class="block text-gray-300 text-sm font-medium mb-2">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter your password"
                    required
                >
            </div>
            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
            >
                Log In
            </button>
        </form>

        <button
            id="devLoginBtn"
            class="absolute bottom-4 left-4 bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded-md transition duration-200"
        >
            Dev Login
        </button>

        <div id="messageBox" class="mt-6 p-3 rounded-lg text-center hidden" role="alert">
            </div>
    </div>

    <div id="homeScreenContainer" class="hidden absolute inset-0 flex flex-col justify-end items-center p-4 z-10">
        <div id="desktopArea">
            </div>

        <div id="startMenu" class="hidden">
            <div class="start-menu-search-area">
                <input type="text" id="startMenuSearchInput" placeholder="Search apps and files...">
                <button id="startMenuSearchBtn">Search</button>
            </div>
            <div id="startMenuSearchResults" class="start-menu-search-results">
                </div>
            <hr class="border-gray-600 my-2">

            <div id="startMenuAppList">
                </div>
            <hr class="border-gray-600 my-2">
            <div id="powerdownBtn" class="start-menu-item text-red-400">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6z" clip-rule="evenodd" />
                </svg>
                Powerdown
            </div>
        </div>

        <div class="taskbar w-full max-w-5xl h-14 rounded-xl flex items-center justify-between px-4">
            <div class="flex items-center space-x-2">
                <button id="startButton" class="taskbar-icon p-2 rounded-lg transition duration-200">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2zm-6 3a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="taskbarPinnedApps" class="flex items-center space-x-2">
                    </div>
            </div>

            <div class="flex items-center space-x-4 text-sm text-white">
                <span class="flex items-center space-x-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5.5 13.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v.5a.5.5 0 01-.5.5h-8a.5.5 0 01-.5-.5v-.5zM5.5 10.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v.5a.5.5 0 01-.5.5h-8a.5.5 0 01-.5-.5v-.5zM5.5 7.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v.5a.5.5 0 01-.5.5h-8a.5.5 0 01-.5-.5v-.5z" />
                        <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zm-5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                </span>
                <span class="flex items-center space-x-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-3V3a1 1 0 00-1-1H9zM5 6h10v7H5V6z" clip-rule="evenodd" />
                    </svg>
                </span>
                <span id="currentTime" class="text-white"></span>
            </div>
        </div>
    </div>

    <div id="aiChatWindow" class="os-window hidden" style="width: 500px; height: 600px;">
        <div id="aiChatHeader" class="os-window-header">
            <span>AI Chatbot</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages os-window-content">
            </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type your message..." autocomplete="off">
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

    <div id="fileExplorerWindow" class="os-window hidden" style="width: 600px; height: 400px;">
        <div id="fileExplorerHeader" class="os-window-header">
            <span>File Explorer</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="fileExplorerContent" class="os-window-content">
            </div>
    </div>

    <div id="appStoreWindow" class="os-window hidden" style="width: 550px; height: 650px;">
        <div id="appStoreHeader" class="os-window-header">
            <span>App Store</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="appStoreContent" class="os-window-content">
            </div>
    </div>

    <div id="mediaViewerWindow" class="os-window hidden" style="width: 700px; height: 500px;">
        <div id="mediaViewerHeader" class="os-window-header">
            <span>MP4/MP3 Viewer</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content">
            <div class="flex flex-col gap-4">
                <label for="mediaFileInput" class="block text-gray-300 text-sm font-medium mb-2">Select MP4 or MP3 File:</label>
                <input type="file" id="mediaFileInput" accept="video/*,audio/*" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="mediaDisplayArea" class="flex-grow flex items-center justify-center bg-black mt-4 rounded-lg overflow-hidden">
                </div>
        </div>
    </div>

    <div id="anuraOSWindow" class="os-window hidden" style="width: 800px; height: 600px;">
        <div id="anuraOSHeader" class="os-window-header">
            <span>AnuraOS</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <iframe class="iframe-app-content" src="https://anura.pro"></iframe>
    </div>

    <div id="eaglercraftWindow" class="os-window hidden" style="width: 900px; height: 700px;">
        <div id="eaglercraftHeader" class="os-window-header">
            <span>Eaglercraft</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <iframe class="iframe-app-content" src="https://eaglercraft.com/mc/1.8.8-wasm/"></iframe>
    </div>

    <div id="noteAppWindow" class="os-window hidden" style="width: 500px; height: 400px;">
        <div id="noteAppHeader" class="os-window-header">
            <span>Note App</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content">
            <textarea id="noteContent" class="w-full h-full bg-gray-700 border border-gray-600 rounded-lg text-white p-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Start typing your notes here..."></textarea>
        </div>
    </div>

    <div id="settingsAppWindow" class="os-window hidden" style="width: 450px; height: 300px;">
        <div id="settingsAppHeader" class="os-window-header">
            <span>Settings</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content">
            <h3 class="text-white text-lg font-semibold mb-4">Tab Title Settings</h3>
            <div class="flex flex-col space-y-3">
                <button class="tab-title-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" data-title="Schoology">Set to Schoology</button>
                <button class="tab-title-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" data-title="Google">Set to Google</button>
                <button class="tab-title-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" data-title="Echo-OS">Set to Echo-OS</button>
                <hr class="border-gray-600 my-2">
                <button id="resetSystemBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold">Reset All Data & Code</button>
            </div>
        </div>
    </div>

    <div id="iframeAppWindow" class="os-window hidden" style="width: 900px; height: 700px;">
        <div id="iframeAppHeader" class="os-window-header">
            <span id="iframeAppTitle">Application</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <iframe id="iframeAppContent" class="iframe-app-content" src=""></iframe>
    </div>


    <div id="echoBrowserWindow" class="os-window hidden" style="width: 800px; height: 600px;">
        <div id="echoBrowserHeader" class="os-window-header">
            <span>Echo Browser</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="browser-address-bar">
            <input type="text" id="echoBrowserUrlInput" placeholder="Enter URL or search term..." class="flex-grow">
            <button id="echoBrowserGoBtn">Go</button>
        </div>
        <div id="echoBrowserContentArea" class="iframe-app-content">
            <iframe id="echoBrowserIframe" class="iframe-app-content" src="https://www.google.com/webhp?igu=1"></iframe>
            <div id="darknessButtonContainer" class="hidden">
                <p>Welcome to the depths of the internet...</p>
                <button id="darknessButton">Access DarkWeb Market</button>
            </div>
        </div>
    </div>

    <div id="tabManagerWindow" class="os-window hidden" style="width: 400px; height: 500px;">
        <div id="tabManagerHeader" class="os-window-header">
            <span>Tab Manager</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="tabManagerContent" class="os-window-content">
            <div class="tab-manager-list" id="runningAppsList">
                <p class="text-gray-400">No applications running.</p>
            </div>
            <div class="tab-manager-virus-controls">
                <button id="closeVirusWindowsBtn">Close All Virus Windows</button>
            </div>
        </div>
    </div>

    <div id="virtualMachineWindow" class="os-window hidden" style="width: 1000px; height: 750px;">
        <div id="virtualMachineHeader" class="os-window-header">
            <span>Virtual Machine</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <iframe id="virtualMachineIframe" class="iframe-app-content" src="about:blank"></iframe>
    </div>

    <div id="aiPhotoGenWindow" class="os-window hidden" style="width: 700px; height: 600px;">
        <div id="aiPhotoGenHeader" class="os-window-header">
            <span>AI Photo Gen</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content ai-photo-gen-content">
            <div class="ai-photo-gen-input-area">
                <input type="text" id="aiPhotoGenPromptInput" placeholder="Enter image prompt..." autocomplete="off">
                <button id="aiPhotoGenGenerateBtn">Generate</button>
            </div>
            <div id="aiPhotoGenImageDisplay" class="ai-photo-gen-image-display">
                <p class="text-gray-400">Enter a prompt and click 'Generate' to create an image.</p>
            </div>
        </div>
    </div>

    <div id="passwordGameWindow" class="os-window hidden" style="width: 600px; height: 700px;">
        <div id="passwordGameHeader" class="os-window-header">
            <span>The Password Game</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content password-game-container">
            <div class="password-game-rules">
                <h3>Password Rules</h3>
                <ul id="passwordRulesDisplay">
                    </ul>
            </div>
            <div class="password-input-area">
                <input type="text" id="passwordInput" placeholder="Enter your password..." autocomplete="off">
                <button id="submitPasswordBtn">Check Password</button>
            </div>
            <div class="password-feedback-area">
                <h3>Validation Feedback</h3>
                <ul id="passwordFeedbackArea">
                    </ul>
            </div>
        </div>
    </div>

    <div id="spendMoneyWindow" class="os-window hidden" style="width: 500px; height: 600px;">
        <div id="spendMoneyHeader" class="os-window-header">
            <span>Spend Money</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content spend-money-container">
            <div class="spend-money-balance" id="currentBalance">
                Balance: $1,000,000,000,000
            </div>

            <div class="spend-money-section">
                <h3>Buy Item</h3>
                <div class="spend-money-input-group">
                    <input type="text" id="buyItemName" placeholder="Item Name">
                    <input type="number" id="buyItemCost" placeholder="Cost (e.g., 1000)" min="0">
                </div>
                <button id="buyItemBtn">Buy</button>
            </div>

            <div class="spend-money-section">
                <h3>Earn Money</h3>
                <div class="spend-money-input-group">
                    <input type="number" id="earnAmount" placeholder="Amount to earn (e.g., 100000000000)" min="0">
                </div>
                <button id="earnMoneyBtn">Earn</button>
            </div>

            <div class="spend-money-section">
                <h3>Transactions</h3>
                <ul id="transactionList" class="spend-money-transactions">
                    </ul>
            </div>
        </div>
    </div>

    <div id="drawingGameWindow" class="os-window hidden" style="width: 700px; height: 650px;">
        <div id="drawingGameHeader" class="os-window-header">
            <span>Drawing Game</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content drawing-game-container">
            <canvas id="drawingCanvas" width="600" height="400"></canvas>
            <div class="drawing-controls">
                <label for="brushColor" class="text-white">Color:</label>
                <input type="color" id="brushColor" value="#000000">

                <label for="brushSize" class="text-white">Size:</label>
                <input type="range" id="brushSize" min="1" max="20" value="5">
                <span id="brushSizeValue" class="text-white">5</span>

                <button id="clearCanvasBtn">Clear Canvas</button>
            </div>
        </div>
    </div>

    <div id="stimulationClickerWindow" class="os-window hidden" style="width: 550px; height: 700px;">
        <div id="stimulationClickerHeader" class="os-window-header">
            <span>Stimulation Clicker</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content stimulation-clicker-container">
            <div id="stimulationDisplay">0 Stimulation</div>
            <button id="mainClickButton">Click Me!</button>

            <div class="upgrades-section">
                <h3>Upgrades</h3>
                <div id="upgradesList">
                    </div>
            </div>
            <div id="chaosVisuals"></div>
        </div>
    </div>

    <div id="darkAppStoreWindow" class="os-window hidden" style="width: 550px; height: 650px;">
        <div id="darkAppStoreHeader" class="os-window-header">
            <span>Dark Market</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="darkAppStoreContent" class="os-window-content">
            </div>
    </div>

    <div id="hackerSimulatorWindow" class="os-window hidden" style="width: 700px; height: 600px;">
        <div id="hackerSimulatorHeader" class="os-window-header">
            <span>Hacker Simulator v1.337</span>
            <div class="flex space-x-2">
                <button class="os-window-control-btn minimize-btn" data-action="minimize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                </button>
                <button class="os-window-control-btn close-btn" data-action="close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="os-window-content hacker-simulator-container">
            <canvas id="binaryBackgroundCanvas"></canvas>
            <div class="hacker-content">
                <h2>CyberSec Password Cracker</h2>
                <div class="hacker-input-group">
                    <label for="targetIP">Target IP Address:</label>
                    <input type="text" id="targetIP" value="192.168.1.100" readonly>
                </div>
                <div class="hacker-input-group">
                    <label for="passwordHash">Password Hash:</label>
                    <input type="text" id="passwordHash" placeholder="Enter hash to crack (e.g., e10adc3949ba59abbe56e057f20f883e)">
                    <button id="crackPasswordBtn">Initiate Brute-Force</button>
                </div>
                <div class="hacker-output-area" id="crackerOutput">
                    <span class="info">Awaiting command...</span><br>
                </div>
            </div>
        </div>
    </div>


    <div id="contextMenu" class="hidden">
        <div id="contextMenuPin" class="context-menu-item" data-action="pin">Pin to Taskbar</div>
        <div id="contextMenuUnpin" class="context-menu-item hidden" data-action="unpin">Unpin from Taskbar</div>
    </div>

    <script>
        // Global error handler to catch any uncaught JavaScript errors
        window.onerror = function(message, source, lineno, colno, error) {
            const errorMessage = `JavaScript Error: ${message} at ${source}:${lineno}:${colno}`;
            console.error(errorMessage, error);
            // Display a user-friendly message in the message box
            showMessage(`An unexpected error occurred: ${message}. Check console for details.`, 'error');
            return true; // Prevent default error handling (browser console output)
        };

        // Get references to the containers and elements
        const loginContainer = document.getElementById('loginContainer');
        const homeScreenContainer = document.getElementById('homeScreenContainer');
        const loginForm = document.getElementById('loginForm');
        const messageBox = document.getElementById('messageBox');
        const currentTimeSpan = document.getElementById('currentTime');
        const devLoginBtn = document.getElementById('devLoginBtn');

        // Start Menu elements
        const startButton = document.getElementById('startButton');
        const startMenu = document.getElementById('startMenu');
        const powerdownBtn = document.getElementById('powerdownBtn');
        const startMenuSearchInput = document.getElementById('startMenuSearchInput');
        const startMenuSearchBtn = document.getElementById('startMenuSearchBtn');
        const startMenuSearchResults = document.getElementById('startMenuSearchResults');
        const startMenuAppList = document.getElementById('startMenuAppList');

        // Chatbot elements
        const aiChatWindow = document.getElementById('aiChatWindow');
        const aiChatHeader = document.getElementById('aiChatHeader');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // File Explorer elements
        const fileExplorerWindow = document.getElementById('fileExplorerWindow');
        const fileExplorerHeader = document.getElementById('fileExplorerHeader');
        const fileExplorerContent = document.getElementById('fileExplorerContent');

        // App Store elements
        const appStoreWindow = document.getElementById('appStoreWindow');
        const appStoreHeader = document.getElementById('appStoreHeader');
        const appStoreContent = document.getElementById('appStoreContent');

        // Media Viewer elements
        const mediaViewerWindow = document.getElementById('mediaViewerWindow');
        const mediaViewerHeader = document.getElementById('mediaViewerHeader');
        const mediaFileInput = document.getElementById('mediaFileInput');
        const mediaDisplayArea = document.getElementById('mediaDisplayArea');

        // AnuraOS elements
        const anuraOSWindow = document.getElementById('anuraOSWindow');
        const anuraOSHeader = document.getElementById('anuraOSHeader');

        // Eaglercraft elements
        const eaglercraftWindow = document.getElementById('eaglercraftWindow');
        const eaglercraftHeader = document.getElementById('eaglercraftHeader');

        // New Note App elements
        const noteAppWindow = document.getElementById('noteAppWindow');
        const noteAppHeader = document.getElementById('noteAppHeader');
        const noteContent = document.getElementById('noteContent');

        // New Settings App elements
        const settingsAppWindow = document.getElementById('settingsAppWindow');
        const settingsAppHeader = document.getElementById('settingsAppHeader');
        const resetSystemBtn = document.getElementById('resetSystemBtn'); // New Reset button

        // New Echo Browser elements
        const echoBrowserWindow = document.getElementById('echoBrowserWindow');
        const echoBrowserHeader = document.getElementById('echoBrowserHeader');
        const echoBrowserUrlInput = document.getElementById('echoBrowserUrlInput');
        const echoBrowserGoBtn = document.getElementById('echoBrowserGoBtn');
        const echoBrowserIframe = document.getElementById('echoBrowserIframe');
        const echoBrowserContentArea = document.getElementById('echoBrowserContentArea'); // New: for toggling iframe/button
        const darknessButtonContainer = document.getElementById('darknessButtonContainer'); // New: for dark web button
        const darknessButton = document.getElementById('darknessButton'); // New: the dark web button

        // New generic iframe app elements
        const iframeAppWindow = document.getElementById('iframeAppWindow');
        const iframeAppHeader = document.getElementById('iframeAppHeader');
        const iframeAppTitle = document.getElementById('iframeAppTitle');
        const iframeAppContent = document.getElementById('iframeAppContent');

        // Tab Manager elements
        const tabManagerWindow = document.getElementById('tabManagerWindow');
        const tabManagerHeader = document.getElementById('tabManagerHeader');
        const runningAppsList = document.getElementById('runningAppsList');
        const closeVirusWindowsBtn = document.getElementById('closeVirusWindowsBtn');

        // Virtual Machine elements
        const virtualMachineWindow = document.getElementById('virtualMachineWindow');
        const virtualMachineHeader = document.getElementById('virtualMachineHeader');
        const virtualMachineIframe = document.getElementById('virtualMachineIframe');

        // AI Photo Gen elements
        const aiPhotoGenWindow = document.getElementById('aiPhotoGenWindow');
        const aiPhotoGenHeader = document.getElementById('aiPhotoGenHeader');
        const aiPhotoGenPromptInput = document.getElementById('aiPhotoGenPromptInput');
        const aiPhotoGenGenerateBtn = document.getElementById('aiPhotoGenGenerateBtn');
        const aiPhotoGenImageDisplay = document.getElementById('aiPhotoGenImageDisplay');

        // Password Game elements
        const passwordGameWindow = document.getElementById('passwordGameWindow');
        const passwordGameHeader = document.getElementById('passwordGameHeader');
        const passwordRulesDisplay = document.getElementById('passwordRulesDisplay');
        const passwordInput = document.getElementById('passwordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const passwordFeedbackArea = document.getElementById('passwordFeedbackArea');

        // Spend Money elements
        const spendMoneyWindow = document.getElementById('spendMoneyWindow');
        const spendMoneyHeader = document.getElementById('spendMoneyHeader');
        const currentBalanceDisplay = document.getElementById('currentBalance');
        const buyItemNameInput = document.getElementById('buyItemName');
        const buyItemCostInput = document.getElementById('buyItemCost');
        const buyItemBtn = document.getElementById('buyItemBtn');
        const earnAmountInput = document.getElementById('earnAmount');
        const earnMoneyBtn = document.getElementById('earnMoneyBtn');
        const transactionList = document.getElementById('transactionList');
        let currentBalance = 1_000_000_000_000; // Starting with 1 Trillion

        // Drawing Game elements
        const drawingGameWindow = document.getElementById('drawingGameWindow');
        const drawingGameHeader = document.getElementById('drawingGameHeader');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const drawingCtx = drawingCanvas.getContext('2d');
        const brushColorInput = document.getElementById('brushColor');
        const brushSizeInput = document.getElementById('brushSize');
        const brushSizeValueSpan = document.getElementById('brushSizeValue');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Stimulation Clicker elements
        const stimulationClickerWindow = document.getElementById('stimulationClickerWindow');
        const stimulationClickerHeader = document.getElementById('stimulationClickerHeader');
        const stimulationDisplay = document.getElementById('stimulationDisplay');
        const mainClickButton = document.getElementById('mainClickButton');
        const upgradesList = document.getElementById('upgradesList');
        const chaosVisualsDiv = document.getElementById('chaosVisuals');
        let stimulation = 0;
        let clickPower = 1;
        let autoClickers = 0;
        let autoClickRate = 1000; // ms per tick
        let autoClickIntervalId = null;
        let chaosLevel = 0; // Controls visual chaos

        // Dark App Store elements
        const darkAppStoreWindow = document.getElementById('darkAppStoreWindow');
        const darkAppStoreHeader = document.getElementById('darkAppStoreHeader');
        const darkAppStoreContent = document.getElementById('darkAppStoreContent');

        // Hacker Simulator elements
        const hackerSimulatorWindow = document.getElementById('hackerSimulatorWindow');
        const hackerSimulatorHeader = document.getElementById('hackerSimulatorHeader');
        const binaryBackgroundCanvas = document.getElementById('binaryBackgroundCanvas');
        const binaryCtx = binaryBackgroundCanvas.getContext('2d');
        const passwordHashInput = document.getElementById('passwordHash');
        const crackPasswordBtn = document.getElementById('crackPasswordBtn');
        const crackerOutput = document.getElementById('crackerOutput');
        let binaryAnimationInterval = null; // To control the binary background animation

        // Desktop elements
        const desktopArea = document.getElementById('desktopArea');

        // Taskbar Pinned Apps Container
        const taskbarPinnedApps = document.getElementById('taskbarPinnedApps');

        // Context Menu elements
        const contextMenu = document.getElementById('contextMenu');
        const contextMenuPin = document.getElementById('contextMenuPin');
        const contextMenuUnpin = document.getElementById('contextMenuUnpin');
        let currentContextMenuAppId = null; // To store which app icon was right-clicked

        // Get a reference to the canvas element and its 2D rendering context
        const backgroundCanvas = document.getElementById('backgroundCanvas');
        const ctx = backgroundCanvas.getContext('2d');

        // Chat history for AI model
        let chatHistory = [];

        // Current directory in file explorer
        let currentDirectory = '/This PC/Users/Admin/Roaming'; // Default starting directory

        // File system structure (Corrected to be truly nested)
        const fileSystem = {
            name: 'Root',
            type: 'directory',
            contents: {
                'This PC': {
                    name: 'This PC',
                    type: 'directory',
                    contents: {
                        'Users': {
                            name: 'Users',
                            type: 'directory',
                            contents: {
                                'Admin': {
                                    name: 'Admin',
                                    type: 'directory',
                                    contents: {
                                        'Roaming': {
                                            name: 'Roaming',
                                            type: 'directory',
                                            contents: {
                                                'Documents': { name: 'Documents', type: 'directory', contents: {} },
                                                'Pictures': { name: 'Pictures', type: 'directory', contents: {} },
                                                'VIRUS': {
                                                    name: 'VIRUS',
                                                    type: 'directory',
                                                    contents: {
                                                        'OH NO': { name: 'OH NO', type: 'file', action: 'virus_errors' },
                                                        'IDIOT Virus.exe': { name: 'IDIOT Virus.exe', type: 'file', action: 'idiot_virus' }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };

        // Map to keep track of all active (open) application windows
        // Key: unique window ID (appId for main windows, generated ID for virus windows), Value: { element: HTMLElement, name: String, isVirusWindow: Boolean }
        const activeWindows = new Map();
        // Array to specifically track windows opened by IDIOT Virus (their unique IDs)
        const idiotVirusWindowIds = [];


        // Define desktop applications
        const desktopApps = {
            'aiChat': {
                name: 'AI Chatbot',
                iconSvg: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.336-3.11c-.813-1.076-1.336-2.365-1.336-3.89C2 6.134 5.582 3 10 3s8 3.134 8 7zM7 9H5v2h2V9zm4 0H9v2h2V9zm4 0h-2v2h2V9z" clip-rule="evenodd" /></svg>`,
                windowElement: aiChatWindow,
                initialDownloaded: true,
                category: "Productivity",
                isDarkwebApp: false
            },
            'fileExplorer': {
                name: 'File Explorer',
                iconSvg: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>`,
                windowElement: fileExplorerWindow,
                initialDownloaded: true,
                category: "System",
                isDarkwebApp: false
            },
            'appStore': {
                name: 'App Store',
                iconSvg: `<svg class="w-6 h-6 text-purple-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5-8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>`,
                windowElement: appStoreWindow,
                initialDownloaded: true,
                category: "System",
                isDarkwebApp: false
            },
            'mediaViewer': {
                name: 'MP4/MP3 Viewer',
                iconSvg: `<svg class="w-6 h-6 text-purple-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`,
                windowElement: mediaViewerWindow,
                initialDownloaded: false,
                description: "View MP4 videos or play MP3 audio from a URL.",
                category: "Multimedia",
                isDarkwebApp: false
            },
            'anuraOS': {
                name: 'AnuraOS',
                iconSvg: `<svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`,
                windowElement: iframeAppWindow,
                initialDownloaded: false,
                description: "Run a web-based operating system in an iframe.",
                category: "Utilities",
                url: "https://anura.pro/",
                isDarkwebApp: false
            },
            'eaglercraft': {
                name: 'Eaglercraft',
                iconSvg: `<svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.325-1.119-1.353-1.119-1.676 0l-2.58 8.74c-.214.733.025 1.474.68 1.776l1.84 1.13c.484.297.818.81.818 1.39v2.928c0 .307.307.558.614.558h1.228c.307 0 .614-.251.614-.558V16.27c0-.58.334-1.093.818-1.39l1.84-1.13c.655-.302.894-1.043.68-1.776l-2.58-8.74zM10 2a1 1 0 011 1v1h-2V3a1 1 0 011-1zm-4 7a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>`,
                windowElement: iframeAppWindow,
                initialDownloaded: false,
                description: "Play Eaglercraft (Minecraft 1.8.8) in your browser.",
                category: "Games",
                url: "https://eaglercraft.com/mc/1.8.8-wasm/",
                isDarkwebApp: false
            },
            'noteApp': {
                name: 'Note App',
                iconSvg: `<svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0118 8.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h10V8.414L11.586 4H6z" clip-rule="evenodd" /></svg>`,
                windowElement: noteAppWindow,
                initialDownloaded: false,
                description: "A simple app for taking notes.",
                category: "Productivity",
                isDarkwebApp: false
            },
            'settingsApp': {
                name: 'Settings',
                iconSvg: `<svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
                windowElement: settingsAppWindow,
                initialDownloaded: true,
                description: "Configure OS settings.",
                category: "System",
                isDarkwebApp: false
            },
            'echoBrowser': {
                name: 'Echo Browser',
                iconSvg: `<svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12 2a1 1 0 00-1 1v1H9V3a1 1 0 00-1-1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2h-3zM5 6h10v7H5V6z" clip-rule="evenodd" /></svg>`,
                windowElement: echoBrowserWindow,
                initialDownloaded: false,
                description: "A simple web browser.",
                category: "Internet",
                isDarkwebApp: false
            },
            'hexanaut': {
                name: 'Hexanut.io',
                iconSvg: `<svg class="w-6 h-6 text-orange-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`,
                windowElement: iframeAppWindow,
                initialDownloaded: false,
                description: "A fun hexagonal strategy game.",
                category: "Games",
                url: "https://hexanaut.io/",
                isDarkwebApp: false
            },
            'curverush': {
                name: 'CurveRush',
                iconSvg: `<svg class="w-6 h-6 text-pink-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`,
                windowElement: iframeAppWindow,
                initialDownloaded: false,
                description: "A fast-paced curve dodging game.",
                category: "Games",
                url: "https://curverush.com/",
                isDarkwebApp: false
            },
            'tabManager': {
                name: 'Tab Manager',
                iconSvg: `<svg class="w-6 h-6 text-teal-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm2 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 5a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`,
                windowElement: tabManagerWindow,
                initialDownloaded: true,
                description: "Manage and close running applications.",
                category: "System",
                isDarkwebApp: false
            },
            'virtualMachine': {
                name: 'Virtual Machine',
                iconSvg: `<svg class="w-6 h-6 text-indigo-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm3 0a1 1 0 10-2 0v4a1 1 0 102 0V6z" clip-rule="evenodd" /></svg>`,
                windowElement: virtualMachineWindow,
                initialDownloaded: true,
                description: "Run another instance of Mini OS.",
                category: "System",
                isDarkwebApp: false
            },
            'aiPhotoGen': {
                name: 'AI Photo Gen',
                iconSvg: `<svg class="w-6 h-6 text-purple-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-4 4 4 4-4V5h-4v4l-4-4-4 4v4z" clip-rule="evenodd" /></svg>`,
                windowElement: aiPhotoGenWindow,
                initialDownloaded: false,
                description: "Generate images using AI from a text prompt.",
                category: "Creative",
                isDarkwebApp: false
            },
            'passwordGame': {
                name: 'The Password Game',
                iconSvg: `<svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>`,
                windowElement: passwordGameWindow,
                initialDownloaded: false, // Changed to false
                description: "A game to test your password creation skills against complex rules.",
                category: "Games",
                isDarkwebApp: false
            },
            'spendMoney': { // New Spend Money App
                name: 'Spend Money',
                iconSvg: `<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 002-2V4H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 0a2 2 0 100 4 2 2 0 000-4z" clip-rule="evenodd" /></svg>`,
                windowElement: spendMoneyWindow,
                initialDownloaded: false,
                description: "Manage your virtual trillion, buy items, and earn more!",
                category: "Games",
                isDarkwebApp: false
            },
            'drawingGame': { // New Drawing Game App
                name: 'Drawing Game',
                iconSvg: `<svg class="w-6 h-6 text-blue-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`,
                windowElement: drawingGameWindow,
                initialDownloaded: false,
                description: "Unleash your creativity with a simple drawing canvas.",
                category: "Creative",
                isDarkwebApp: false
            },
            'stimulationClicker': { // New Stimulation Clicker App
                name: 'Stimulation Clicker',
                iconSvg: `<svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 102 0V8a1 1 0 00-1.555-.832z" clip-rule="evenodd" /></svg>`,
                windowElement: stimulationClickerWindow,
                initialDownloaded: false,
                description: "Start simple, get chaotic. A clicker game with a twist.",
                category: "Games",
                isDarkwebApp: false
            },
            'darkAppStore': { // New Dark App Store App
                name: 'Dark Market',
                iconSvg: `<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`,
                windowElement: darkAppStoreWindow,
                initialDownloaded: false, // Not available in regular app store
                description: "Access the hidden market for specialized tools.",
                category: "System",
                isDarkwebApp: true // This app itself is a darkweb app
            },
            'hackerSimulator': { // New Hacker Simulator App
                name: 'Hacker Simulator',
                iconSvg: `<svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 102 0V8a1 1 0 00-1.555-.832z" clip-rule="evenodd" /></svg>`,
                windowElement: hackerSimulatorWindow,
                initialDownloaded: false, // Only available in Dark App Store
                description: "Simulate advanced hacking operations.",
                category: "Utilities",
                isDarkwebApp: true // This is a darkweb app
            }
        };

        // Initialize downloadedApps set based on initialDownloaded property
        let downloadedApps = new Set(Object.keys(desktopApps).filter(appId => desktopApps[appId].initialDownloaded));

        // Initialize pinnedApps based on downloadedApps (only downloaded apps can be pinned)
        let pinnedApps = new Set(Array.from(downloadedApps)); // All initially downloaded apps are also initially pinned

        // --- Utility Functions ---

        // Function to display messages in the message box
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else {
                messageBox.classList.add('bg-blue-600', 'text-white');
            }
            // Hide message after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // Function to update the current time in the taskbar
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            currentTimeSpan.textContent = `${hours}:${minutes}`;
        }

        // Function to draw the gradient background on the canvas
        function drawGradientBackground() {
            const gradient = ctx.createLinearGradient(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            gradient.addColorStop(0, '#4facfe');
            gradient.addColorStop(0.5, '#6a7bff');
            gradient.addColorStop(1, '#9171ff');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
        }

        // Function to resize canvas to fill the window and redraw
        function resizeCanvas() {
            backgroundCanvas.width = window.innerWidth;
            backgroundCanvas.height = window.innerHeight;
            drawGradientBackground();
        }

        // Function to load the home screen
        function loadHomeScreen() {
            loginContainer.classList.add('hidden');
            homeScreenContainer.classList.remove('hidden');
            updateTime();
            setInterval(updateTime, 60000);
            renderDesktopIcons(); // Render desktop icons when home screen loads
            renderTaskbarIcons(); // Render taskbar icons when home screen loads
            renderStartMenuApps(); // Render apps in Start Menu
            renderAppStoreApps(); // Render apps in App Store
            renderTabManagerContent(); // Initial render for Tab Manager
        }

        // Function to handle window dragging and control buttons
        function setupWindow(element, header, appId) {
            let isDragging = false;
            let offsetX, offsetY;
            let originalWidth, originalHeight, originalTop, originalLeft;
            let isMaximized = false;

            // Store initial position and size for restoration
            const storeOriginalState = () => {
                const rect = element.getBoundingClientRect();
                originalWidth = element.style.width || `${rect.width}px`;
                originalHeight = element.style.height || `${rect.height}px`;
                originalTop = element.style.top || `${rect.top}px`;
                originalLeft = element.style.left || `${rect.left}px`;
            };

            // Call once on setup to capture initial state if not already done by CSS
            storeOriginalState();

            const startDrag = (e) => {
                if (isMaximized) return; // Disable dragging when maximized
                isDragging = true;
                offsetX = e.clientX - element.getBoundingClientRect().left;
                offsetY = e.clientY - element.getBoundingClientRect().top;
                header.style.cursor = 'grabbing';
                element.style.transition = 'none'; // Disable transition during drag
                element.style.zIndex = 102; // Bring to front when dragging
            };

            const doDrag = (e) => {
                if (!isDragging) return;

                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;

                // Keep window within viewport bounds
                newX = Math.max(0, Math.min(newX, window.innerWidth - element.offsetWidth));
                newY = Math.max(0, Math.min(newY, window.innerHeight - element.offsetHeight));

                element.style.left = `${newX}px`;
                element.style.top = `${newY}px`;
                element.style.transform = 'none'; // Remove transform as we are setting top/left directly
            };

            const endDrag = () => {
                isDragging = false;
                header.style.cursor = 'grab'; // Reset cursor
                element.style.transition = ''; // Re-enable transition
                element.style.zIndex = 100; // Reset z-index
            };

            header.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', endDrag);

            // Control buttons functionality
            header.querySelectorAll('.os-window-control-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const action = button.dataset.action;
                    console.log(`Window control button clicked for ${element.id}:`, action);
                    if (action === 'close') {
                        // If maximized, restore first then hide
                        if (isMaximized) {
                            maximizeWindow(element, button); // This will restore it
                        }
                        element.classList.add('hidden');
                        unregisterWindow(appId); // Unregister when closed
                        // Stop specific app animations/intervals when closed
                        if (appId === 'hackerSimulator') {
                            stopBinaryAnimation();
                        }
                    } else if (action === 'minimize') {
                        element.classList.add('hidden');
                        // Optionally, add a visual cue on the taskbar if implementing minimized state there
                    } else if (action === 'maximize' || action === 'restore') {
                        maximizeWindow(element, button);
                    }
                });
            });

            // Maximize/Restore logic
            function maximizeWindow(windowElement, button) {
                const maximizeRestoreBtn = button || windowElement.querySelector('.maximize-restore-btn'); // Get button if not passed
                if (!isMaximized) {
                    // Maximize
                    storeOriginalState(); // Capture current state before maximizing
                    windowElement.style.width = '100vw';
                    windowElement.style.height = 'calc(100vh - 56px)'; // Adjust for taskbar
                    windowElement.style.top = '0';
                    windowElement.style.left = '0';
                    windowElement.style.transform = 'none'; // Remove centering transform
                    isMaximized = true;
                    maximizeRestoreBtn.dataset.action = 'restore';
                    maximizeRestoreBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>`; // Restore icon
                } else {
                    // Restore
                    windowElement.style.width = originalWidth;
                    windowElement.style.height = originalHeight;
                    windowElement.style.top = originalTop;
                    windowElement.style.left = originalLeft;
                    // Re-apply original transform if it was centered or set by initial CSS
                    if (originalTop.includes('%') || originalLeft.includes('%') || originalWidth.includes('%') || originalHeight.includes('%') || originalTop === '50%' || originalLeft === '50%') {
                         windowElement.style.top = '50%';
                         windowElement.style.left = '50%';
                         windowElement.style.transform = 'translate(-50%, -50%)';
                    }
                    isMaximized = false;
                    maximizeRestoreBtn.dataset.action = 'maximize';
                    maximizeRestoreBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>`; // Maximize icon
                }
            }

            // Expose a function to restore the window from external calls (e.g., when opening a minimized app)
            element.restoreIfMaximized = () => {
                if (isMaximized) {
                    const maximizeRestoreBtn = element.querySelector('.maximize-restore-btn');
                    maximizeWindow(element, maximizeRestoreBtn);
                }
            };
        }

        // Function to handle desktop icon dragging
        function makeDesktopIconDraggable(iconElement) {
            let isDragging = false;
            let offsetX, offsetY;

            iconElement.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only for dragging
                    isDragging = true;
                    offsetX = e.clientX - iconElement.getBoundingClientRect().left;
                    offsetY = e.clientY - iconElement.getBoundingClientRect().top;
                    iconElement.style.transition = 'none'; // Disable transition during drag
                    iconElement.style.zIndex = 101; // Bring to front
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;

                // Keep icon within desktop area bounds
                const desktopRect = desktopArea.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, desktopRect.width - iconElement.offsetWidth));
                newY = Math.max(0, Math.min(newY, desktopRect.height - iconElement.offsetHeight));

                iconElement.style.left = `${newX}px`;
                iconElement.style.top = `${newY}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                iconElement.style.transition = ''; // Re-enable transition
                iconElement.style.zIndex = ''; // Reset z-index
            });
        }

        // --- Window Management (for Tab Manager) ---
        function registerWindow(appId, element, isVirusWindow = false) {
            // Use a unique ID for each window instance, especially for virus windows
            const uniqueWindowId = isVirusWindow ? `idiotBrowser-${Date.now()}-${Math.random().toString(36).substring(2, 9)}` : appId;
            element.dataset.uniqueWindowId = uniqueWindowId; // Store this ID on the element

            activeWindows.set(uniqueWindowId, { element, name: desktopApps[appId]?.name || `IDIOT Browser`, isVirusWindow, appId: appId }); // Store original appId for lookup
            renderTabManagerContent();
            return uniqueWindowId; // Return the unique ID
        }

        function unregisterWindow(uniqueWindowId) {
            activeWindows.delete(uniqueWindowId);
            // Remove from idiotVirusWindowIds if it was a virus window
            const index = idiotVirusWindowIds.indexOf(uniqueWindowId);
            if (index > -1) {
                idiotVirusWindowIds.splice(index, 1);
            }
            renderTabManagerContent();
        }

        function closeWindow(uniqueWindowId) {
            const windowInfo = activeWindows.get(uniqueWindowId);
            if (windowInfo) {
                windowInfo.element.classList.add('hidden');
                unregisterWindow(uniqueWindowId);
                // If it's a dynamically created virus window, also remove it from the DOM
                if (windowInfo.isVirusWindow) {
                    windowInfo.element.remove();
                }
                // Stop specific app animations/intervals when closed
                if (windowInfo.appId === 'hackerSimulator') {
                    stopBinaryAnimation();
                }
            }
        }

        // --- App Specific Functions ---

        // Chatbot Functions
        async function sendMessage() {
            const prompt = chatInput.value.trim();
            if (prompt === '') return;

            appendMessage(prompt, 'user');
            chatInput.value = '';

            const loadingBubble = appendMessage('AI is thinking...', 'ai loading');
            chatMessages.scrollTop = chatMessages.scrollHeight;

            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            try {
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will inject this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Attempt to parse error data
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                loadingBubble.remove();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    appendMessage(aiResponse, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    appendMessage('Error: Unexpected AI response structure.', 'ai');
                    console.error('Unexpected AI response structure:', result);
                }
            } catch (error) {
                loadingBubble.remove();
                appendMessage(`Error: Failed to get AI response. ${error.message}`, 'ai');
                console.error('Error fetching AI response:', error);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');
            if (sender === 'user') {
                messageElement.classList.add('message-user');
            } else if (sender === 'ai') {
                messageElement.classList.add('message-ai');
            } else if (sender === 'ai loading') {
                messageElement.classList.add('loading-indicator');
            }
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            return messageElement;
        }

        // File Explorer Functions
        function renderDirectory(path) {
            fileExplorerContent.innerHTML = ''; // Clear current content
            const currentDirContents = getDirectoryContents(path);

            if (!currentDirContents) {
                fileExplorerContent.innerHTML = `<p class="text-red-400">Error: Directory not found or inaccessible. Path: ${path}</p>`;
                return;
            }

            // Add a "Back" button if not at root
            if (path !== '/') {
                const backButton = document.createElement('div');
                backButton.classList.add('file-item');
                backButton.innerHTML = `
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-gray-300">.. (Back)</span>
                `;
                backButton.addEventListener('click', () => {
                    // Correctly calculate parent path for nested structure
                    const pathParts = path.split('/').filter(p => p !== '');
                    pathParts.pop(); // Remove current directory
                    currentDirectory = '/' + pathParts.join('/'); // Reconstruct path
                    if (currentDirectory === '//') currentDirectory = '/'; // Handle root case if it becomes '//'
                    renderDirectory(currentDirectory);
                });
                fileExplorerContent.appendChild(backButton);
            }

            // Render contents of the current directory
            for (const itemName in currentDirContents) {
                const item = currentDirContents[itemName];
                const itemElement = document.createElement('div');
                itemElement.classList.add('file-item');
                itemElement.dataset.itemName = itemName; // Store item name for click handling

                if (item.type === 'directory') {
                    itemElement.innerHTML = `
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                        </svg>
                        ${itemName}
                    `;
                    itemElement.addEventListener('click', () => {
                        const newPath = path === '/' ? `/${itemName}` : `${path}/${itemName}`;
                        currentDirectory = newPath.replace(/\/\//g, '/'); // Replace any double slashes
                        renderDirectory(currentDirectory);
                    });
                } else if (item.type === 'file') {
                    itemElement.innerHTML = `
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0118 8.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h10V8.414L11.586 4H6z" clip-rule="evenodd" />
                        </svg>
                        ${itemName}
                    `;
                    itemElement.addEventListener('click', () => {
                        if (item.action === 'virus_errors') {
                            triggerVirusErrors();
                        } else if (item.action === 'idiot_virus') {
                            triggerIdiotVirus();
                        } else {
                            showMessage(`Opening file: ${itemName}`, 'info');
                            // In a real OS, you'd open the file content
                        }
                    });
                }
                fileExplorerContent.appendChild(itemElement);
            }
        }

        // Helper to get nested directory content (Corrected logic for nested structure)
        function getDirectoryContents(path) {
            let current = fileSystem; // Start at the root of the nested structure
            const parts = path.split('/').filter(p => p !== ''); // e.g., ['This PC', 'Users', 'Admin', 'Roaming']

            for (const part of parts) {
                if (current.contents && current.contents[part] && current.contents[part].type === 'directory') {
                    current = current.contents[part]; // Move to the found directory object
                } else {
                    return null; // Path not found or not a directory
                }
            }
            return current.contents; // Return the contents of the final directory
        }


        // Virus Error Functionality
        function triggerVirusErrors() {
            // Hide all app windows
            Object.values(desktopApps).forEach(app => {
                if (app.windowElement) app.windowElement.classList.add('hidden');
            });
            startMenu.style.display = 'none'; // Ensure Start Menu is hidden

            // Temporarily show login container (to display messages)
            loginContainer.classList.remove('hidden');
            homeScreenContainer.classList.add('hidden');


            const errorMessages = [
                "ERROR: System integrity compromised.",
                "WARNING: Critical process terminated.",
                "ALERT: Data corruption detected.",
                "FATAL: Memory access violation.",
                "FAILURE: Device driver error.",
                "CRITICAL: Kernel panic.",
                "SYSTEM DOWN: File system unreadable.",
                "SECURITY BREACH: Unauthorized access.",
                "RESOURCE EXHAUSTION: Out of memory.",
                "VIRUS DETECTED: Immediate restart required."
            ];

            let errorCount = 0;
            const displayInterval = setInterval(() => {
                if (errorCount < errorMessages.length) {
                    showMessage(errorMessages[errorCount], 'error');
                    errorCount++;
                } else {
                    clearInterval(displayInterval);
                    // After all errors, return to home screen
                    setTimeout(() => {
                        loginContainer.classList.add('hidden');
                        homeScreenContainer.classList.remove('hidden');
                    }, 2000); // Give user time to read last error
                }
            }, 500); // Display a new error every 0.5 seconds
        }

        // IDIOT Virus Functionality
        function triggerIdiotVirus() {
            showMessage('IDIOT Virus activated! Opening multiple browser windows...', 'error');
            const numWindowsToOpen = 10; // Adjust as needed
            for (let i = 0; i < numWindowsToOpen; i++) {
                // Dynamically create a new Echo Browser window
                const newEchoBrowserWindow = document.createElement('div');
                newEchoBrowserWindow.classList.add('os-window');
                newEchoBrowserWindow.style.width = '800px';
                newEchoBrowserWindow.style.height = '600px';
                // Randomize position slightly
                const randomX = Math.floor(Math.random() * (window.innerWidth - 800));
                const randomY = Math.floor(Math.random() * (window.innerHeight - 600 - 56)); // Account for taskbar
                newEchoBrowserWindow.style.left = `${randomX}px`;
                newEchoBrowserWindow.style.top = `${randomY}px`;
                newEchoBrowserWindow.style.transform = 'none'; // Override default centering

                const uniqueId = `idiotBrowser-${Date.now()}-${i}`;
                newEchoBrowserWindow.id = uniqueId;

                newEchoBrowserWindow.innerHTML = `
                    <div class="os-window-header">
                        <span>IDIOT Browser ${i + 1}</span>
                        <div class="flex space-x-2">
                            <button class="os-window-control-btn minimize-btn" data-action="minimize">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="os-window-control-btn maximize-restore-btn" data-action="maximize">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2h10v10H5V5z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="os-window-control-btn close-btn" data-action="close">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="browser-address-bar">
                        <input type="text" class="echoBrowserUrlInput flex-grow" placeholder="Enter URL or search term...">
                        <button class="echoBrowserGoBtn">Go</button>
                    </div>
                    <iframe class="iframe-app-content" src="https://www.google.com/webhp?igu=1"></iframe>
                `;
                document.body.appendChild(newEchoBrowserWindow);

                // Setup dragging and controls for the new window
                setupWindow(newEchoBrowserWindow, newEchoBrowserWindow.querySelector('.os-window-header'), 'echoBrowser'); // Pass 'echoBrowser' as appId for consistent icon/name lookup
                const registeredId = registerWindow('echoBrowser', newEchoBrowserWindow, true); // Register as a virus window
                idiotVirusWindowIds.push(registeredId); // Keep track of these specific windows' unique IDs

                // Add event listeners for the new browser's input and button
                const urlInput = newEchoBrowserWindow.querySelector('.echoBrowserUrlInput');
                const goBtn = newEchoBrowserWindow.querySelector('.echoBrowserGoBtn');
                const browserIframe = newEchoBrowserWindow.querySelector('.iframe-app-content');

                goBtn.addEventListener('click', () => {
                    let url = urlInput.value.trim();
                    if (url === '') {
                        url = 'https://www.google.com/webhp?igu=1';
                    } else if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = `https://www.google.com/search?igu=1&q=${encodeURIComponent(url)}`;
                    }
                    browserIframe.src = url;
                });
                urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        goBtn.click();
                    }
                });
            }
        }

        function closeAllVirusWindows() {
            // Iterate over a copy of the array because closing windows modifies the original
            [...idiotVirusWindowIds].forEach(uniqueWindowId => {
                closeWindow(uniqueWindowId);
            });
            idiotVirusWindowIds.length = 0; // Ensure the array is completely cleared
            showMessage('All virus windows closed!', 'success');
        }


        // Function to reset system state (used by Powerdown and Reset All Data)
        function resetSystemState() {
            loginContainer.classList.remove('hidden'); // Go back to login screen
            homeScreenContainer.classList.add('hidden'); // Ensure home screen is hidden
            Object.values(desktopApps).forEach(app => {
                if (app.windowElement) app.windowElement.classList.add('hidden');
            });
            // Close all dynamically created virus windows
            closeAllVirusWindows();

            startMenu.style.display = 'none'; // Ensure Start Menu is hidden
            chatHistory = []; // Clear chat history
            currentDirectory = '/This PC/Users/Admin/Roaming'; // Reset file explorer
            activeWindows.clear(); // Clear all tracked active windows
            // Reset Password Game state
            passwordInput.value = '';
            passwordFeedbackArea.innerHTML = '';
            // Reset Spend Money state
            currentBalance = 1_000_000_000_000;
            updateBalanceDisplay();
            transactionList.innerHTML = '';
            // Reset Drawing Game state
            if (drawingCtx) {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingCtx.fillStyle = '#f0f0f0';
                drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }
            // Reset Stimulation Clicker state
            clearInterval(autoClickIntervalId);
            stimulation = 0;
            clickPower = 1;
            autoClickers = 0;
            autoClickRate = 1000;
            chaosLevel = 0;
            saveStimulationState(); // Save cleared state
            renderStimulationClicker();
            chaosVisualsDiv.innerHTML = ''; // Clear chaos visuals
            // Reset Hacker Simulator state
            stopBinaryAnimation();
            crackerOutput.innerHTML = '<span class="info">Awaiting command...</span><br>';
            passwordHashInput.value = '';


            // Re-initialize downloaded and pinned apps to their default state
            downloadedApps = new Set(Object.keys(desktopApps).filter(appId => desktopApps[appId].initialDownloaded));
            pinnedApps = new Set(Array.from(downloadedApps));

            renderDesktopIcons(); // Re-render desktop icons based on new downloadedApps
            renderTaskbarIcons(); // Re-render taskbar icons based on new pinnedApps
            renderStartMenuApps(); // Re-render start menu apps
            renderAppStoreApps(); // Re-render app store apps
            renderTabManagerContent(); // Re-render tab manager content
        }

        // New function to reset all code and data by reloading the page
        function resetAllDataAndCode() {
            showMessage('Resetting all data and code. The system will restart...', 'info');
            // Perform a soft reset of in-memory data first
            resetSystemState();
            // Then, force a full page reload to re-execute all JavaScript
            setTimeout(() => {
                window.location.reload();
            }, 1000); // Give time for the message to be seen
        }

        // --- Desktop and Taskbar Rendering ---

        function renderDesktopIcons() {
            desktopArea.innerHTML = ''; // Clear existing icons
            let xPos = 20; // Initial X position
            let yPos = 20; // Initial Y position
            const iconWidth = 80;
            const iconHeight = 90;
            const padding = 10;

            Object.keys(desktopApps).forEach(appId => {
                if (downloadedApps.has(appId)) { // Only render if downloaded
                    const app = desktopApps[appId];
                    const iconElement = document.createElement('div');
                    iconElement.classList.add('desktop-icon');
                    iconElement.id = `desktop-${appId}`;
                    iconElement.dataset.appId = appId;
                    iconElement.innerHTML = `
                        ${app.iconSvg}
                        <span>${app.name}</span>
                    `;
                    iconElement.style.left = `${xPos}px`;
                    iconElement.style.top = `${yPos}px`;

                    // Add click listener to open app
                    iconElement.addEventListener('click', (e) => {
                        if (e.target.closest('.desktop-icon')) {
                            toggleAppWindow(appId);
                            hideContextMenu();
                        }
                    });

                    // Add right-click listener for context menu
                    iconElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e, appId);
                    });

                    makeDesktopIconDraggable(iconElement);
                    desktopArea.appendChild(iconElement);

                    // Simple layout: move to next column or next row
                    yPos += iconHeight + padding;
                    if (yPos + iconHeight > desktopArea.clientHeight) {
                        yPos = 20;
                        xPos += iconWidth + padding;
                    }
                }
            });
        }

        function renderTaskbarIcons() {
            taskbarPinnedApps.innerHTML = ''; // Clear existing pinned icons

            // Add Widgets icon (this is always there for now)
            const staticIcons = [
                { id: 'widgets', svg: `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM13 7a2 2 0 00-2-2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2zM13 15a2 2 0 00-2-2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" /></svg>` },
            ];

            // Render static icons (if any)
            staticIcons.forEach(icon => {
                const button = document.createElement('button');
                button.classList.add('taskbar-icon', 'p-2', 'rounded-lg', 'transition', 'duration-200');
                button.innerHTML = icon.svg;
                taskbarPinnedApps.appendChild(button);
            });


            // Render dynamically pinned apps
            pinnedApps.forEach(appId => {
                const app = desktopApps[appId];
                if (app && downloadedApps.has(appId)) { // Only render if downloaded and pinned
                    const button = document.createElement('button');
                    button.classList.add('taskbar-icon', 'p-2', 'rounded-lg', 'transition', 'duration-200');
                    button.innerHTML = app.iconSvg;
                    button.dataset.appId = appId; // Store app ID for toggling window
                    button.addEventListener('click', () => toggleAppWindow(appId));
                    taskbarPinnedApps.appendChild(button);
                }
            });
        }

        function renderStartMenuApps() {
            startMenuAppList.innerHTML = ''; // Clear existing apps

            // Group apps by category
            const categorizedApps = {};
            Object.keys(desktopApps).forEach(appId => {
                const app = desktopApps[appId];
                if (downloadedApps.has(appId) && !app.isDarkwebApp) { // Only show downloaded non-darkweb apps
                    const category = app.category || 'Other';
                    if (!categorizedApps[category]) {
                        categorizedApps[category] = [];
                    }
                    categorizedApps[category].push({ appId, app });
                }
            });

            // Sort categories (e.g., System first, then alphabetical)
            const sortedCategories = Object.keys(categorizedApps).sort((a, b) => {
                if (a === 'System') return -1;
                if (b === 'System') return 1;
                return a.localeCompare(b);
            });

            sortedCategories.forEach(category => {
                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('text-gray-400', 'text-xs', 'font-semibold', 'uppercase', 'px-3', 'py-2', 'mt-2');
                categoryHeader.textContent = category;
                startMenuAppList.appendChild(categoryHeader);

                categorizedApps[category].sort((a, b) => a.app.name.localeCompare(b.app.name)).forEach(({ appId, app }) => {
                    const appItem = document.createElement('div');
                    appItem.classList.add('start-menu-item');
                    appItem.dataset.appId = appId;
                    appItem.innerHTML = `${app.iconSvg} ${app.name}`;
                    appItem.addEventListener('click', () => {
                        toggleAppWindow(appId);
                        startMenu.style.display = 'none'; // Close start menu after launching
                    });
                    startMenuAppList.appendChild(appItem);
                });
            });
        }


        function toggleAppWindow(appId) {
            console.log('Attempting to toggle app window:', appId);
            const app = desktopApps[appId];
            if (app && app.windowElement) {
                // If it's the generic iframe window, set its content and title
                if (app.windowElement === iframeAppWindow && app.url) {
                    iframeAppWindow.querySelector('#iframeAppTitle').textContent = app.name;
                    iframeAppWindow.querySelector('#iframeAppContent').src = app.url;
                } else if (appId === 'virtualMachine') {
                    // For Virtual Machine, set iframe src to current page URL
                    virtualMachineIframe.src = window.location.href;
                }

                app.windowElement.classList.remove('hidden'); // Ensure it's visible
                app.windowElement.style.zIndex = 102; // Bring to front
                app.windowElement.restoreIfMaximized(); // Restore if it was maximized
                console.log('App window opened:', appId);

                // Register the window if it's not already registered (e.g., if it was minimized)
                if (!activeWindows.has(appId)) {
                    registerWindow(appId, app.windowElement);
                }


                // Specific focus or rendering for opened apps
                if (appId === 'aiChat') {
                    chatInput.focus();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else if (appId === 'fileExplorer') {
                    renderDirectory(currentDirectory); // Re-render file explorer content
                } else if (appId === 'mediaViewer') {
                    mediaFileInput.value = '';
                    mediaDisplayArea.innerHTML = '';
                    mediaFileInput.focus();
                } else if (appId === 'echoBrowser') {
                    echoBrowserUrlInput.focus();
                    // When opening browser, ensure darkness button is hidden by default
                    echoBrowserIframe.classList.remove('hidden');
                    darknessButtonContainer.classList.add('hidden');
                } else if (appId === 'tabManager') {
                    renderTabManagerContent(); // Refresh content when Tab Manager is opened
                } else if (appId === 'aiPhotoGen') {
                    aiPhotoGenPromptInput.focus();
                } else if (appId === 'passwordGame') { // New app logic
                    renderPasswordGameRules();
                    passwordInput.value = ''; // Clear input on open
                    passwordFeedbackArea.innerHTML = ''; // Clear feedback on open
                    passwordInput.focus();
                } else if (appId === 'spendMoney') { // New Spend Money app logic
                    updateBalanceDisplay();
                    buyItemNameInput.value = '';
                    buyItemCostInput.value = '';
                    earnAmountInput.value = '';
                    transactionList.innerHTML = ''; // Clear transactions on open
                } else if (appId === 'drawingGame') {
                    initDrawingGame(); // Initialize drawing canvas
                } else if (appId === 'stimulationClicker') {
                    loadStimulationState(); // Load game state
                    renderStimulationClicker(); // Render game UI
                    startAutoClicker(); // Start auto-clicker if any
                } else if (appId === 'darkAppStore') { // Dark App Store
                    renderDarkAppStoreApps();
                } else if (appId === 'hackerSimulator') { // Hacker Simulator
                    initHackerSimulator();
                }
            } else {
                console.warn('Attempted to open unknown or non-existent app:', appId);
            }
            startMenu.style.display = 'none'; // Close start menu if open
        }

        // --- Context Menu Functions ---
        function showContextMenu(e, appId) {
            currentContextMenuAppId = appId;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;

            // Update Pin/Unpin text
            if (pinnedApps.has(appId)) {
                contextMenuPin.classList.add('hidden');
                contextMenuUnpin.classList.remove('hidden');
            } else {
                contextMenuPin.classList.remove('hidden');
                contextMenuUnpin.classList.add('hidden');
            }
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
            currentContextMenuAppId = null;
        }

        function togglePin(appId) {
            if (pinnedApps.has(appId)) {
                pinnedApps.delete(appId);
                showMessage(`${desktopApps[appId].name} unpinned from taskbar.`, 'info');
            } else {
                pinnedApps.add(appId);
                showMessage(`${desktopApps[appId].name} pinned to taskbar.`, 'success');
            }
            renderTaskbarIcons(); // Re-render taskbar to reflect changes
            hideContextMenu();
        }

        // --- Start Menu Search Functionality ---
        function performStartMenuSearch() {
            const query = startMenuSearchInput.value.toLowerCase().trim();
            startMenuSearchResults.innerHTML = ''; // Clear previous results

            if (query === '') {
                startMenuSearchResults.classList.add('hidden');
                startMenuAppList.classList.remove('hidden'); // Show app list if search is empty
                return;
            }

            startMenuSearchResults.classList.remove('hidden');
            startMenuAppList.classList.add('hidden'); // Hide app list during search

            let resultsFound = false;

            // Search through downloaded desktop apps (excluding darkweb apps for regular search)
            Object.keys(desktopApps).forEach(appId => {
                const app = desktopApps[appId];
                if (downloadedApps.has(appId) && !app.isDarkwebApp && app.name.toLowerCase().includes(query)) {
                    const resultItem = document.createElement('div');
                    resultItem.classList.add('result-item');
                    resultItem.innerHTML = `${app.iconSvg} <span>${app.name} (App)</span>`;
                    resultItem.addEventListener('click', () => {
                        toggleAppWindow(appId);
                        startMenu.style.display = 'none'; // Close start menu after launching
                        startMenuSearchInput.value = ''; // Clear search input
                        startMenuSearchResults.classList.add('hidden'); // Hide results
                        startMenuAppList.classList.remove('hidden'); // Show app list
                    });
                    startMenuSearchResults.appendChild(resultItem);
                    resultsFound = true;
                }
            });


            // Search through file system (simplified for top-level directories for now)
            // This is a simplified search and won't traverse deep into the file system
            const searchFileSystem = (dirContents, currentPath) => {
                if (!dirContents) return; // Guard against null or undefined contents

                for (const itemName in dirContents) {
                    const item = dirContents[itemName];
                    const fullPath = currentPath === '/' ? `/${itemName}` : `${currentPath}/${itemName}`;
                    if (itemName.toLowerCase().includes(query)) {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('result-item');
                        let iconSvg = '';
                        if (item.type === 'directory') {
                            iconSvg = `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>`;
                            resultItem.innerHTML = `${iconSvg} <span>${itemName} (Folder)</span>`;
                            resultItem.addEventListener('click', () => {
                                toggleAppWindow('fileExplorer'); // Open file explorer
                                currentDirectory = fullPath; // Navigate to the found directory
                                renderDirectory(currentDirectory);
                                startMenu.style.display = 'none';
                                startMenuSearchInput.value = '';
                                startMenuSearchResults.classList.add('hidden');
                                startMenuAppList.classList.remove('hidden');
                            });
                        } else if (item.type === 'file') {
                            iconSvg = `<svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0118 8.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h10V8.414L11.586 4H6z" clip-rule="evenodd" /></svg>`;
                            resultItem.innerHTML = `${iconSvg} <span>${itemName} (File)</span>`;
                            resultItem.addEventListener('click', () => {
                                toggleAppWindow('fileExplorer'); // Open file explorer
                                currentDirectory = fullPath.substring(0, fullPath.lastIndexOf('/')); // Navigate to parent directory
                                renderDirectory(currentDirectory);
                                showMessage(`File "${itemName}" found.`, 'info');
                                startMenu.style.display = 'none';
                                startMenuSearchInput.value = '';
                                startMenuSearchResults.classList.add('hidden');
                                startMenuAppList.classList.remove('hidden');
                            });
                        }
                        startMenuSearchResults.appendChild(resultItem);
                        resultsFound = true;
                    }
                    if (item.type === 'directory' && item.contents) { // Ensure 'contents' exists before recursing
                        searchFileSystem(item.contents, fullPath); // Recursively search subdirectories
                    }
                }
            };
            searchFileSystem(fileSystem.contents, '/'); // Start search from the root's contents


            if (!resultsFound) {
                startMenuSearchResults.innerHTML = `<p class="text-gray-400 p-2">No results found for "${query}".</p>`;
            }
        }

        // --- App Store Functionality ---
        function renderAppStoreApps() {
            appStoreContent.innerHTML = ''; // Clear existing content

            const categorizedApps = {};
            Object.keys(desktopApps).forEach(appId => {
                const app = desktopApps[appId];
                if (!app.initialDownloaded && !app.isDarkwebApp) { // Only show apps not initially downloaded AND not darkweb apps
                    const category = app.category || 'Utilities'; // Default category
                    if (!categorizedApps[category]) {
                        categorizedApps[category] = [];
                    }
                    categorizedApps[category].push({ appId, app });
                }
            });

            // Sort categories for consistent display (e.g., Games first, then Utilities)
            const sortedCategories = Object.keys(categorizedApps).sort((a, b) => {
                if (a === 'Games') return -1;
                if (b === 'Games') return 1;
                return a.localeCompare(b);
            });


            if (sortedCategories.length === 0) {
                appStoreContent.innerHTML = `<p class="text-gray-400">No new apps available in the store.</p>`;
                return;
            }

            sortedCategories.forEach(category => {
                const categoryHeader = document.createElement('h3');
                categoryHeader.classList.add('text-white', 'text-xl', 'font-semibold', 'mb-3', 'mt-4');
                categoryHeader.textContent = category;
                appStoreContent.appendChild(categoryHeader);

                categorizedApps[category].sort((a, b) => a.app.name.localeCompare(b.app.name)).forEach(({ appId, app }) => {
                    const appStoreItem = document.createElement('div');
                    appStoreItem.classList.add('app-store-item');
                    appStoreItem.innerHTML = `
                        <div class="app-store-item-info">
                            ${app.iconSvg}
                            <div>
                                <span class="app-name">${app.name}</span>
                                <span class="app-description">${app.description || 'No description available.'}</span>
                            </div>
                        </div>
                        <button data-app-id="${appId}" class="download-btn">
                            ${downloadedApps.has(appId) ? 'Open' : 'Download'}
                        </button>
                    `;

                    const downloadButton = appStoreItem.querySelector('.download-btn');
                    if (downloadedApps.has(appId)) {
                        downloadButton.disabled = false;
                        downloadButton.addEventListener('click', () => toggleAppWindow(appId));
                    } else {
                        downloadButton.addEventListener('click', () => downloadApp(appId));
                    }
                    appStoreContent.appendChild(appStoreItem);
                });
            });
        }

        function downloadApp(appId) {
            downloadedApps.add(appId);
            showMessage(`${desktopApps[appId].name} downloaded successfully!`, 'success');
            renderDesktopIcons();
            renderTaskbarIcons();
            renderStartMenuApps();
            renderAppStoreApps(); // Re-render App Store to update button state
            renderDarkAppStoreApps(); // Re-render Dark App Store too
        }

        // --- Dark App Store Functionality ---
        function renderDarkAppStoreApps() {
            darkAppStoreContent.innerHTML = ''; // Clear existing content

            const categorizedApps = {};
            Object.keys(desktopApps).forEach(appId => {
                const app = desktopApps[appId];
                if (app.isDarkwebApp) { // Only show darkweb apps
                    const category = app.category || 'Utilities'; // Default category
                    if (!categorizedApps[category]) {
                        categorizedApps[category] = [];
                    }
                    categorizedApps[category].push({ appId, app });
                }
            });

            // Sort categories for consistent display
            const sortedCategories = Object.keys(categorizedApps).sort((a, b) => a.localeCompare(b));

            if (sortedCategories.length === 0) {
                darkAppStoreContent.innerHTML = `<p class="text-gray-400">No darkweb apps available in this market.</p>`;
                return;
            }

            sortedCategories.forEach(category => {
                const categoryHeader = document.createElement('h3');
                categoryHeader.classList.add('text-white', 'text-xl', 'font-semibold', 'mb-3', 'mt-4');
                categoryHeader.textContent = category;
                darkAppStoreContent.appendChild(categoryHeader);

                categorizedApps[category].sort((a, b) => a.app.name.localeCompare(b.app.name)).forEach(({ appId, app }) => {
                    const appStoreItem = document.createElement('div');
                    appStoreItem.classList.add('app-store-item');
                    appStoreItem.innerHTML = `
                        <div class="app-store-item-info">
                            ${app.iconSvg}
                            <div>
                                <span class="app-name">${app.name}</span>
                                <span class="app-description">${app.description || 'No description available.'}</span>
                            </div>
                        </div>
                        <button data-app-id="${appId}" class="download-btn">
                            ${downloadedApps.has(appId) ? 'Open' : 'Download'}
                        </button>
                    `;

                    const downloadButton = appStoreItem.querySelector('.download-btn');
                    if (downloadedApps.has(appId)) {
                        downloadButton.disabled = false;
                        downloadButton.addEventListener('click', () => toggleAppWindow(appId));
                    } else {
                        downloadButton.addEventListener('click', () => downloadApp(appId));
                    }
                    darkAppStoreContent.appendChild(appStoreItem);
                });
            });
        }


        // --- Media Viewer Functionality ---
        let currentMediaObjectUrl = null; // To store the Blob URL for revocation

        function loadMediaFile() {
            const file = mediaFileInput.files[0];
            mediaDisplayArea.innerHTML = ''; // Clear previous media

            if (currentMediaObjectUrl) {
                URL.revokeObjectURL(currentMediaObjectUrl); // Revoke previous Blob URL
                currentMediaObjectUrl = null;
            }

            if (!file) {
                mediaDisplayArea.innerHTML = `<p class="text-gray-400">Please select a media file.</p>`;
                return;
            }

            // Check file type
            if (file.type.startsWith('video/')) {
                const videoElement = document.createElement('video');
                currentMediaObjectUrl = URL.createObjectURL(file);
                videoElement.src = currentMediaObjectUrl;
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.classList.add('w-full', 'h-full', 'object-contain');
                videoElement.onerror = () => {
                    mediaDisplayArea.innerHTML = `<p class="text-red-400">Error loading video. The file might be corrupted or unsupported.</p>`;
                    if (currentMediaObjectUrl) {
                        URL.revokeObjectURL(currentMediaObjectUrl);
                        currentMediaObjectUrl = null;
                    }
                };
                mediaDisplayArea.appendChild(videoElement);
            } else if (file.type.startsWith('audio/')) {
                const audioElement = document.createElement('audio');
                currentMediaObjectUrl = URL.createObjectURL(file);
                audioElement.src = currentMediaObjectUrl;
                audioElement.controls = true;
                audioElement.autoplay = true;
                audioElement.classList.add('w-full');
                audioElement.onerror = () => {
                    mediaDisplayArea.innerHTML = `<p class="text-red-400">Error loading audio. The file might be corrupted or unsupported.</p>`;
                    if (currentMediaObjectUrl) {
                        URL.revokeObjectURL(currentMediaObjectUrl);
                        currentMediaObjectUrl = null;
                    }
                };
                mediaDisplayArea.appendChild(audioElement);
            } else {
                mediaDisplayArea.innerHTML = `<p class="text-red-400">Unsupported file type: ${file.type}. Please select an MP4 or MP3 file.</p>`;
            }
        }

        // --- Echo Browser Functions ---
        function loadEchoBrowserContent() {
            let url = echoBrowserUrlInput.value.trim();

            if (url === 'echo://darkness') {
                echoBrowserIframe.classList.add('hidden');
                darknessButtonContainer.classList.remove('hidden');
                echoBrowserContentArea.style.backgroundColor = '#0d1a26'; // Apply dark background
            } else {
                echoBrowserIframe.classList.remove('hidden');
                darknessButtonContainer.classList.add('hidden');
                echoBrowserContentArea.style.backgroundColor = ''; // Reset background
                if (url === '' || url === 'echo://home') {
                    url = 'https://www.google.com/webhp?igu=1'; // Default to Google
                } else if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    // If it's not a URL, assume it's a search query
                    url = `https://www.google.com/search?igu=1&q=${encodeURIComponent(url)}`;
                }
                echoBrowserIframe.src = url;
            }
        }


        // --- Tab Manager Functions ---
        function renderTabManagerContent() {
            runningAppsList.innerHTML = ''; // Clear existing list

            if (activeWindows.size === 0) {
                runningAppsList.innerHTML = '<p class="text-gray-400">No applications running.</p>';
                return;
            }

            activeWindows.forEach((windowInfo, uniqueWindowId) => {
                const appItem = document.createElement('div');
                appItem.classList.add('tab-manager-item');
                appItem.innerHTML = `
                    <div class="tab-manager-item-info">
                        ${desktopApps[windowInfo.appId]?.iconSvg || `<svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 102 0V8a1 1 0 00-1.555-.832z" clip-rule="evenodd" /></svg>`}
                        <span>${windowInfo.name} ${windowInfo.isVirusWindow ? '(Virus)' : ''}</span>
                    </div>
                    <button data-unique-window-id="${uniqueWindowId}" class="close-app-btn">Close</button>
                `;
                runningAppsList.appendChild(appItem);
            });

            // Add event listeners to the new close buttons
            runningAppsList.querySelectorAll('.close-app-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const uniqueWindowIdToClose = e.target.dataset.uniqueWindowId;
                    closeWindow(uniqueWindowIdToClose);
                });
            });
        }

        // --- AI Photo Gen Functions ---
        async function generateImage() {
            const prompt = aiPhotoGenPromptInput.value.trim();
            if (!prompt) {
                showMessage('Please enter a prompt for the image.', 'error');
                return;
            }

            aiPhotoGenImageDisplay.innerHTML = `
                <div class="ai-photo-gen-loading">
                    <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating image...
                </div>
            `;
            aiPhotoGenGenerateBtn.disabled = true; // Disable button during generation

            try {
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    aiPhotoGenImageDisplay.innerHTML = `<img src="${imageUrl}" alt="Generated AI Image">`;
                    showMessage('Image generated successfully!', 'success');
                } else {
                    aiPhotoGenImageDisplay.innerHTML = `<p class="text-red-400">Failed to generate image. Please try a different prompt.</p>`;
                    showMessage('Image generation failed.', 'error');
                    console.error('Image generation API response error:', result);
                }
            } catch (error) {
                aiPhotoGenImageDisplay.innerHTML = `<p class="text-red-400">Error: Could not connect to AI image generation service.</p>`;
                showMessage('Error generating image.', 'error');
                console.error('Error in AI image generation fetch:', error);
            } finally {
                aiPhotoGenGenerateBtn.disabled = false; // Re-enable button
            }
        }

        // --- Password Game Functions ---

        const passwordRules = [
            { id: 'length', text: 'Your password must be at least 5 characters.', check: (p) => p.length >= 5 },
            { id: 'number', text: 'Your password must include a number.', check: (p) => /\d/.test(p) },
            { id: 'uppercase', text: 'Your password must include an uppercase letter.', check: (p) => /[A-Z]/.test(p) },
            { id: 'specialChar', text: 'Your password must include a special character.', check: (p) => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(p) },
            { id: 'digitSum', text: 'The digits in your password must add up to 25.', check: (p) => calculateDigitSum(p) === 25 },
            { id: 'month', text: 'Your password must include a month of the year.', check: (p) => months.some(month => p.toLowerCase().includes(month.toLowerCase())) },
            { id: 'romanNumeral', text: 'Your password must include a roman numeral.', check: (p) => getRomanNumerals(p).length > 0 },
            { id: 'sponsor', text: 'Your password must include one of our sponsors: (Bookian, Gameaverse, Starbucks).', check: (p) => sponsors.some(sponsor => p.toLowerCase().includes(sponsor.toLowerCase())) }
            // Rule 9 (romanProduct) has been removed as per user request
        ];

        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const sponsors = ["Bookian", "Gameaverse", "Starbucks"]; // Updated sponsors

        const romanMap = {
            'I': 1, 'V': 5, 'X': 10, 'L': 50, 'C': 100, 'D': 500, 'M': 1000
        };

        // Function to convert Roman numeral string to decimal value
        function romanToDecimal(roman) {
            let value = 0;
            for (let i = 0; i < roman.length; i++) {
                const current = romanMap[roman[i]];
                const next = romanMap[roman[i + 1]];
                if (next && current < next) {
                    value -= current;
                } else {
                    value += current;
                }
            }
            return value;
        }

        // Function to extract all Roman numerals from a string
        function getRomanNumerals(text) {
            // Regex to find sequences of Roman numeral characters.
            // This is a basic check and might not catch all valid/invalid combinations.
            const romanRegex = /(M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}))/gmi;
            const matches = text.match(romanRegex);
            return matches || [];
        }

        // Function to calculate sum of digits in a password
        function calculateDigitSum(password) {
            return password.split('')
                           .filter(char => /\d/.test(char))
                           .reduce((sum, digit) => sum + parseInt(digit, 10), 0);
        }

        // Function to calculate product of Roman numeral values (no longer used for a rule, but kept if needed elsewhere)
        function calculateRomanNumeralProduct(password) {
            const romanNumerals = getRomanNumerals(password);
            if (romanNumerals.length === 0) return 0; // No Roman numerals, product is 0

            let product = 1;
            for (const roman of romanNumerals) {
                product *= romanToDecimal(roman.toUpperCase());
            }
            return product;
        }


        function renderPasswordGameRules() {
            passwordRulesDisplay.innerHTML = '';
            passwordRules.forEach((rule, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    <span>[RULE ${String(index + 1).padStart(2, '0')}] :: ${rule.text}</span>
                `;
                passwordRulesDisplay.appendChild(listItem);
            });
        }

        function checkPassword() {
            const password = passwordInput.value;
            passwordFeedbackArea.innerHTML = '';
            let allRulesPassed = true;

            passwordRules.forEach((rule, index) => {
                const passed = rule.check(password);
                const listItem = document.createElement('li');
                listItem.classList.add(passed ? 'pass' : 'fail');
                listItem.innerHTML = `
                    ${passed ?
                        `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>` :
                        `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
                    }
                    <span>RULE ${String(index + 1).padStart(2, '0')}: ${rule.text} - ${passed ? 'PASSED' : 'FAILED'}</span>
                `;
                passwordFeedbackArea.appendChild(listItem);
                if (!passed) {
                    allRulesPassed = false;
                }
            });

            if (allRulesPassed) {
                showMessage('Congratulations! Your password meets all the rules!', 'success');
            } else {
                showMessage('Password does not meet all requirements. Keep trying!', 'error');
            }
        }

        // --- Spend Money Functions ---
        function updateBalanceDisplay() {
            currentBalanceDisplay.textContent = `Balance: $${currentBalance.toLocaleString()}`;
        }

        function addTransaction(type, description, amount) {
            const listItem = document.createElement('li');
            listItem.classList.add(type);
            const sign = type === 'buy' ? '-' : '+';
            listItem.innerHTML = `<span>${description}</span><span>${sign}$${amount.toLocaleString()}</span>`;
            transactionList.prepend(listItem); // Add to top of list
            // Keep list from getting too long
            if (transactionList.children.length > 10) {
                transactionList.removeChild(transactionList.lastChild);
            }
        }

        function buyItem() {
            const itemName = buyItemNameInput.value.trim();
            const itemCost = parseFloat(buyItemCostInput.value);

            if (!itemName) {
                showMessage('Please enter an item name.', 'error');
                return;
            }
            if (isNaN(itemCost) || itemCost <= 0) {
                showMessage('Please enter a valid cost (a positive number).', 'error');
                return;
            }

            if (currentBalance >= itemCost) {
                currentBalance -= itemCost;
                updateBalanceDisplay();
                addTransaction('buy', `Purchased ${itemName}`, itemCost);
                showMessage(`Successfully bought ${itemName} for $${itemCost.toLocaleString()}.`, 'success');
                buyItemNameInput.value = '';
                buyItemCostInput.value = '';
            } else {
                showMessage(`Insufficient funds to buy ${itemName}. You need $${(itemCost - currentBalance).toLocaleString()} more.`, 'error');
            }
        }

        function earnMoney() {
            const earnAmount = parseFloat(earnAmountInput.value);

            if (isNaN(earnAmount) || earnAmount <= 0) {
                showMessage('Please enter a valid amount to earn (a positive number).', 'error');
                return;
            }

            currentBalance += earnAmount;
            updateBalanceDisplay();
            addTransaction('earn', `Earned money`, earnAmount);
            showMessage(`Successfully earned $${earnAmount.toLocaleString()}.`, 'success');
            earnAmountInput.value = '';
        }

        // --- Drawing Game Functions ---
        function initDrawingGame() {
            // Set canvas size dynamically based on its parent container, or use fixed size
            // For simplicity, we'll use a fixed size here, but responsive design would adjust this.
            drawingCanvas.width = drawingCanvas.offsetWidth;
            drawingCanvas.height = drawingCanvas.offsetHeight;

            // Set initial drawing properties
            drawingCtx.strokeStyle = brushColorInput.value;
            drawingCtx.lineWidth = brushSizeInput.value;
            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';

            // Fill canvas with white background initially
            drawingCtx.fillStyle = '#f0f0f0';
            drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);

            // Event Listeners for drawing
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing); // Stop drawing if mouse leaves canvas

            // Touch events for mobile drawing
            drawingCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling
                const touch = e.touches[0];
                startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
            });
            drawingCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent scrolling
                const touch = e.touches[0];
                draw({ clientX: touch.clientX, clientY: touch.clientY });
            });
            drawingCanvas.addEventListener('touchend', stopDrawing);
            drawingCanvas.addEventListener('touchcancel', stopDrawing);


            // Control listeners
            brushColorInput.addEventListener('input', () => {
                drawingCtx.strokeStyle = brushColorInput.value;
            });
            brushSizeInput.addEventListener('input', () => {
                drawingCtx.lineWidth = brushSizeInput.value;
                brushSizeValueSpan.textContent = brushSizeInput.value;
            });
            clearCanvasBtn.addEventListener('click', () => {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingCtx.fillStyle = '#f0f0f0'; // Re-fill with white
                drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            });
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(drawingCanvas, e);
            [lastX, lastY] = [pos.x, pos.y];
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(drawingCanvas, e);
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(pos.x, pos.y);
            drawingCtx.stroke();
            [lastX, lastY] = [pos.x, pos.y];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // --- Stimulation Clicker Functions ---
        const stimulationUpgrades = [
            { id: 'autoClicker1', name: 'Basic Auto-Clicker', cost: 100, effect: () => { autoClickers += 1; }, bought: 0, max: 5, autoClickRate: 1000, stimulationPerTick: 1 },
            { id: 'clickPower1', name: 'Click Power Boost', cost: 50, effect: () => { clickPower *= 2; }, bought: 0, max: 3 },
            { id: 'fasterAutoClick', name: 'Faster Auto-Clicks', cost: 500, effect: () => { autoClickRate = Math.max(100, autoClickRate * 0.8); }, bought: 0, max: 2 },
            { id: 'chaosVisuals1', name: 'Visual Distortion', cost: 200, effect: () => { chaosLevel += 1; }, bought: 0, max: 1 },
            { id: 'autoClicker2', name: 'Advanced Auto-Clicker', cost: 1000, effect: () => { autoClickers += 5; }, bought: 0, max: 3, autoClickRate: 1000, stimulationPerTick: 5 },
            { id: 'clickPower2', name: 'Super Click Power', cost: 750, effect: () => { clickPower *= 3; }, bought: 0, max: 1 },
            { id: 'chaosVisuals2', name: 'Intense Visuals', cost: 1500, effect: () => { chaosLevel += 1; }, bought: 0, max: 1 },
        ];

        function saveStimulationState() {
            localStorage.setItem('stimulationClickerState', JSON.stringify({
                stimulation,
                clickPower,
                autoClickers,
                autoClickRate,
                chaosLevel,
                upgrades: stimulationUpgrades.map(u => ({ id: u.id, bought: u.bought }))
            }));
        }

        function loadStimulationState() {
            const savedState = localStorage.getItem('stimulationClickerState');
            if (savedState) {
                const state = JSON.parse(savedState);
                stimulation = state.stimulation || 0;
                clickPower = state.clickPower || 1;
                autoClickers = state.autoClickers || 0;
                autoClickRate = state.autoClickRate || 1000;
                chaosLevel = state.chaosLevel || 0;

                state.upgrades.forEach(savedUpgrade => {
                    const upgrade = stimulationUpgrades.find(u => u.id === savedUpgrade.id);
                    if (upgrade) {
                        upgrade.bought = savedUpgrade.bought;
                    }
                });
            }
        }

        function updateStimulationDisplay() {
            stimulationDisplay.textContent = `${Math.floor(stimulation).toLocaleString()} Stimulation`;
        }

        function renderStimulationClicker() {
            updateStimulationDisplay();
            upgradesList.innerHTML = ''; // Clear existing upgrades

            stimulationUpgrades.forEach(upgrade => {
                const upgradeItem = document.createElement('div');
                upgradeItem.classList.add('upgrade-item');

                const currentCost = upgrade.cost * Math.pow(1.5, upgrade.bought); // Exponential cost increase
                const isMaxed = upgrade.max && upgrade.bought >= upgrade.max;

                upgradeItem.innerHTML = `
                    <div class="upgrade-item-info">
                        <span class="upgrade-item-name">${upgrade.name} (${upgrade.bought}${upgrade.max ? `/${upgrade.max}` : ''})</span>
                        <span class="upgrade-item-cost">${isMaxed ? 'MAX' : `Cost: ${Math.floor(currentCost).toLocaleString()} Stimulation`}</span>
                    </div>
                    <button data-upgrade-id="${upgrade.id}" ${stimulation < currentCost || isMaxed ? 'disabled' : ''}>
                        ${isMaxed ? 'Maxed' : 'Buy'}
                    </button>
                `;
                upgradesList.appendChild(upgradeItem);
            });

            upgradesList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', buyUpgrade);
            });

            applyChaosVisuals();
        }

        function addStimulation(amount) {
            stimulation += amount;
            updateStimulationDisplay();
            saveStimulationState();
            renderStimulationClicker(); // Re-render to update button states
        }

        function buyUpgrade(event) {
            const upgradeId = event.target.dataset.upgradeId;
            const upgrade = stimulationUpgrades.find(u => u.id === upgradeId);

            if (upgrade) {
                const currentCost = upgrade.cost * Math.pow(1.5, upgrade.bought);
                if (stimulation >= currentCost && (!upgrade.max || upgrade.bought < upgrade.max)) {
                    stimulation -= currentCost;
                    upgrade.bought++;
                    upgrade.effect(); // Apply the upgrade's effect
                    showMessage(`Bought ${upgrade.name}!`, 'success');
                    saveStimulationState();
                    renderStimulationClicker(); // Re-render to update display and button states
                    startAutoClicker(); // Restart auto-clicker if rate changed or new auto-clickers
                } else if (upgrade.max && upgrade.bought >= upgrade.max) {
                    showMessage(`You've maxed out ${upgrade.name}!`, 'info');
                } else {
                    showMessage(`Not enough stimulation for ${upgrade.name}.`, 'error');
                }
            }
        }

        function startAutoClicker() {
            clearInterval(autoClickIntervalId); // Clear any existing interval
            if (autoClickers > 0) {
                autoClickIntervalId = setInterval(() => {
                    const totalAutoStimulation = autoClickers * (stimulationUpgrades.find(u => u.id === 'autoClicker1')?.stimulationPerTick || 1) +
                                                 (stimulationUpgrades.find(u => u.id === 'autoClicker2')?.stimulationPerTick || 0) * (stimulationUpgrades.find(u => u.id === 'autoClicker2')?.bought || 0);
                    addStimulation(totalAutoStimulation);
                }, autoClickRate);
            }
        }

        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            const size = Math.random() * 10 + 5; // Random size between 5 and 15
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 70%)`; // Random color
            chaosVisualsDiv.appendChild(particle);

            // Remove particle after animation
            particle.addEventListener('animationend', () => {
                particle.remove();
            });
        }

        function applyChaosVisuals() {
            if (chaosLevel >= 1) {
                mainClickButton.style.boxShadow = `0 0 20px rgba(255, 0, 255, 0.7), 0 0 30px rgba(0, 255, 255, 0.7)`;
                mainClickButton.style.animation = 'pulse 1s infinite alternate';
            } else {
                mainClickButton.style.boxShadow = '';
                mainClickButton.style.animation = '';
            }
            if (chaosLevel >= 2) {
                // More intense visuals, maybe background color changes or screen shake
                // For simplicity, let's make particles more frequent and larger
                chaosVisualsDiv.style.opacity = 1; // Ensure it's visible
            } else {
                chaosVisualsDiv.style.opacity = 0;
            }
        }

        // Keyframe for pulse animation (for chaos visuals)
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes pulse {
                from { transform: scale(1); box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4); }
                to { transform: scale(1.05); box-shadow: 0 8px 20px rgba(66, 153, 225, 0.6), 0 0 30px rgba(255, 0, 255, 0.8); }
            }
        `;
        document.head.appendChild(styleSheet);

        // --- Hacker Simulator Functions ---
        const binaryChars = '01';
        let binaryColumns = [];
        let binaryFontSize = 15;
        let dropSpeed = 20; // pixels per frame

        function initBinaryBackground() {
            binaryBackgroundCanvas.width = hackerSimulatorWindow.clientWidth;
            binaryBackgroundCanvas.height = hackerSimulatorWindow.clientHeight;

            const numColumns = Math.floor(binaryBackgroundCanvas.width / binaryFontSize);
            binaryColumns = Array(numColumns).fill(0).map(() => ({
                y: Math.random() * binaryBackgroundCanvas.height,
                speed: Math.random() * 5 + 1 // Random speed for each column
            }));

            binaryCtx.font = `${binaryFontSize}px monospace`;
            binaryCtx.fillStyle = '#0f0'; // Green color for binary
            binaryCtx.textAlign = 'center';

            if (!binaryAnimationInterval) {
                animateBinaryBackground();
            }
        }

        function animateBinaryBackground() {
            binaryCtx.clearRect(0, 0, binaryBackgroundCanvas.width, binaryBackgroundCanvas.height);

            for (let i = 0; i < binaryColumns.length; i++) {
                const x = i * binaryFontSize + binaryFontSize / 2;
                let y = binaryColumns[i].y;

                // Draw a few characters in a "stream"
                for (let j = 0; j < 5; j++) { // Draw 5 characters per column
                    const char = binaryChars[Math.floor(Math.random() * binaryChars.length)];
                    binaryCtx.fillText(char, x, y - j * binaryFontSize);
                }

                y += binaryColumns[i].speed; // Move down

                // Reset column if it goes off screen
                if (y > binaryBackgroundCanvas.height + binaryFontSize * 5) {
                    binaryColumns[i].y = 0;
                    binaryColumns[i].speed = Math.random() * 5 + 1; // New random speed
                } else {
                    binaryColumns[i].y = y;
                }
            }
            binaryAnimationInterval = requestAnimationFrame(animateBinaryBackground);
        }

        function stopBinaryAnimation() {
            if (binaryAnimationInterval) {
                cancelAnimationFrame(binaryAnimationInterval);
                binaryAnimationInterval = null;
            }
        }

        function initHackerSimulator() {
            initBinaryBackground(); // Start the binary background animation
            // Ensure cracker output is clear on open
            crackerOutput.innerHTML = '<span class="info">Awaiting command...</span><br>';
            passwordHashInput.value = '';
        }

        function crackPassword() {
            const hash = passwordHashInput.value.trim();
            if (hash === '') {
                appendToCrackerOutput('<span class="error">Error: No hash provided.</span>');
                return;
            }

            crackerOutput.innerHTML = ''; // Clear previous output
            appendToCrackerOutput('<span class="info">Initiating brute-force attack...</span>');
            appendToCrackerOutput('<span class="info">Analyzing hash type...</span>');

            let attempts = 0;
            const maxAttempts = 100; // Simulate a long process
            const crackingSpeed = 50; // ms per attempt line

            const crackingInterval = setInterval(() => {
                if (attempts < maxAttempts) {
                    const randomChar = () => Math.random().toString(36).charAt(2);
                    const randomHashPart = Array.from({ length: 8 }, randomChar).join('');
                    const randomPasswordPart = Array.from({ length: Math.floor(Math.random() * 5) + 3 }, randomChar).join('');
                    appendToCrackerOutput(`[${attempts.toString().padStart(3, '0')}] Attempting: ${randomPasswordPart} -> ${randomHashPart}...`);
                    crackerOutput.scrollTop = crackerOutput.scrollHeight; // Scroll to bottom
                    attempts++;
                } else {
                    clearInterval(crackingInterval);
                    appendToCrackerOutput('<span class="info">Target hash not found in dictionary.</span>');
                    appendToCrackerOutput('<span class="info">Switching to advanced permutation algorithm...</span>');

                    setTimeout(() => {
                        const success = Math.random() > 0.5; // 50% chance of success
                        if (success) {
                            const crackedPassword = Math.random().toString(36).substring(2, 10); // Fake cracked password
                            appendToCrackerOutput(`<span class="success">SUCCESS! Password cracked: <span style="font-weight: bold;">${crackedPassword}</span></span>`);
                            showMessage('Password cracked successfully!', 'success');
                        } else {
                            appendToCrackerOutput('<span class="error">FAILED! Password could not be cracked. Target system secured.</span>');
                            showMessage('Password cracking failed.', 'error');
                        }
                        crackerOutput.scrollTop = crackerOutput.scrollHeight;
                    }, 2000); // Simulate processing time
                }
            }, crackingSpeed);
        }

        function appendToCrackerOutput(message) {
            crackerOutput.innerHTML += message + '<br>';
        }


        // --- Event Listeners ---

        // Login Form and Dev Login
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            console.log('Attempting login with username:', username, 'and password:', password); // Added log
            if (username === 'admin' && password === 'password') {
                showMessage('Login successful! Welcome to Echo OS.', 'success');
                console.log('Login successful, loading home screen...'); // Added log
                setTimeout(loadHomeScreen, 1500);
            } else {
                showMessage('Invalid username or password.', 'error');
                console.log('Login failed: Invalid credentials.'); // Added log
            }
        });

        devLoginBtn.addEventListener('click', function() {
            console.log('Dev Login button clicked.'); // Added log
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'password';
            loginForm.dispatchEvent(new Event('submit'));
        });

        // Start Menu Toggle
        startButton.addEventListener('click', (e) => {
            console.log('Start button clicked.'); // Added log
            e.stopPropagation(); // Prevent document click from immediately closing it
            if (startMenu.style.display === 'none' || startMenu.style.display === '') {
                startMenu.style.display = 'flex';
                // Clear search and show app list when opening
                startMenuSearchInput.value = '';
                startMenuSearchResults.innerHTML = '';
                startMenuSearchResults.classList.add('hidden');
                startMenuAppList.classList.remove('hidden');
                renderStartMenuApps(); // Re-render app list to ensure it's up-to-date
            } else {
                startMenu.style.display = 'none';
            }
            hideContextMenu(); // Hide context menu if open
        });

        // Powerdown Button
        powerdownBtn.addEventListener('click', () => {
            console.log('Powerdown button clicked.'); // Added log
            startMenu.style.display = 'none'; // Close menu
            showMessage('Shutting down...', 'info');
            setTimeout(resetSystemState, 1000); // Simulate shutdown delay
        });

        // Start Menu App Launchers (dynamic, so no direct listeners here)

        // Start Menu Search Bar Events
        startMenuSearchBtn.addEventListener('click', performStartMenuSearch);
        startMenuSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performStartMenuSearch();
            }
        });
        startMenuSearchInput.addEventListener('input', () => {
            if (startMenuSearchInput.value.trim() === '') {
                startMenuSearchResults.innerHTML = '';
                startMenuSearchResults.classList.add('hidden');
                startMenuAppList.classList.remove('hidden');
            } else {
                performStartMenuSearch();
            }
        });


        // Chatbot interaction
        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Media Viewer interaction (changed to file input)
        mediaFileInput.addEventListener('change', loadMediaFile);

        // Echo Browser interaction (for the main Echo Browser window)
        echoBrowserGoBtn.addEventListener('click', loadEchoBrowserContent);
        echoBrowserUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadEchoBrowserContent();
            }
        });
        // Darkness button in Echo Browser
        darknessButton.addEventListener('click', () => {
            toggleAppWindow('darkAppStore');
        });


        // Tab Manager virus control button
        closeVirusWindowsBtn.addEventListener('click', closeAllVirusWindows);

        // AI Photo Gen interaction
        aiPhotoGenGenerateBtn.addEventListener('click', generateImage);
        aiPhotoGenPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateImage();
            }
        });

        // Password Game interaction
        submitPasswordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('input', checkPassword); // Live feedback as user types

        // Spend Money interaction
        buyItemBtn.addEventListener('click', buyItem);
        earnMoneyBtn.addEventListener('click', earnMoney);
        buyItemCostInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                buyItem();
            }
        });
        earnAmountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                earnMoney();
            }
        });

        // Stimulation Clicker interaction
        mainClickButton.addEventListener('click', () => {
            addStimulation(clickPower);
            if (chaosLevel >= 2) { // Only create particles if chaos level is high enough
                const rect = mainClickButton.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                createParticle(x, y);
            }
        });

        // Hacker Simulator interaction
        crackPasswordBtn.addEventListener('click', crackPassword);
        passwordHashInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                crackPassword();
            }
        });


        // Context Menu Item Clicks
        contextMenuPin.addEventListener('click', () => {
            if (currentContextMenuAppId) {
                togglePin(currentContextMenuAppId);
            }
        });

        contextMenuUnpin.addEventListener('click', () => {
            if (currentContextMenuAppId) {
                togglePin(currentContextMenuAppId);
            }
        });

        // Hide context menu and start menu if clicking anywhere else on the document
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && contextMenu.style.display === 'block') {
                hideContextMenu();
            }
            if (!startButton.contains(e.target) && !startMenu.contains(e.target) && startMenu.style.display === 'flex') {
                startMenu.style.display = 'none';
            }
        });

        // Settings App Tab Title Buttons
        // Delegated event listener for dynamically added buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-title-btn')) {
                const newTitle = e.target.dataset.title;
                document.title = newTitle;
                showMessage(`Tab title changed to "${newTitle}"`, 'info');
            }
        });

        // Settings App Reset Button
        resetSystemBtn.addEventListener('click', resetAllDataAndCode);


        // --- Initial Setup and Event Listeners ---

        // Make all app windows draggable and add control buttons
        // Note: For main app windows, the appId is also used as the uniqueWindowId
        setupWindow(aiChatWindow, aiChatHeader, 'aiChat');
        setupWindow(fileExplorerWindow, fileExplorerHeader, 'fileExplorer');
        setupWindow(appStoreWindow, appStoreHeader, 'appStore');
        setupWindow(mediaViewerWindow, mediaViewerHeader, 'mediaViewer');
        setupWindow(anuraOSWindow, anuraOSHeader, 'anuraOS');
        setupWindow(eaglercraftWindow, eaglercraftHeader, 'eaglercraft');
        setupWindow(noteAppWindow, noteAppHeader, 'noteApp');
        setupWindow(settingsAppWindow, settingsAppHeader, 'settingsApp');
        setupWindow(echoBrowserWindow, echoBrowserHeader, 'echoBrowser');
        setupWindow(iframeAppWindow, iframeAppHeader, 'iframeApp'); // Generic iframe window
        setupWindow(tabManagerWindow, tabManagerHeader, 'tabManager'); // Tab Manager window
        setupWindow(virtualMachineWindow, virtualMachineHeader, 'virtualMachine'); // Virtual Machine window
        setupWindow(aiPhotoGenWindow, aiPhotoGenHeader, 'aiPhotoGen'); // AI Photo Gen window
        setupWindow(passwordGameWindow, passwordGameHeader, 'passwordGame'); // Password Game window
        setupWindow(spendMoneyWindow, spendMoneyHeader, 'spendMoney'); // Spend Money window
        setupWindow(drawingGameWindow, drawingGameHeader, 'drawingGame'); // Drawing Game window
        setupWindow(stimulationClickerWindow, stimulationClickerHeader, 'stimulationClicker'); // Stimulation Clicker window
        setupWindow(darkAppStoreWindow, darkAppStoreHeader, 'darkAppStore'); // Dark App Store window
        setupWindow(hackerSimulatorWindow, hackerSimulatorHeader, 'hackerSimulator'); // Hacker Simulator window


        document.addEventListener('DOMContentLoaded', () => {
            // Explicitly ensure the login screen is visible and all other main UI elements are hidden
            loginContainer.classList.remove('hidden');
            homeScreenContainer.classList.add('hidden');
            // Hide all predefined app windows initially
            Object.values(desktopApps).forEach(app => {
                if (app.windowElement) {
                    app.windowElement.classList.add('hidden');
                }
            });

            startMenu.style.display = 'none'; // Ensure Start Menu is hidden on load
            contextMenu.style.display = 'none'; // Ensure context menu is hidden on load
            resizeCanvas(); // Draw the initial background
            document.title = "Echo OS"; // Set default tab title on load
        });

        window.addEventListener('resize', () => {
            resizeCanvas();
            // Also resize binary background canvas if hacker simulator is open
            if (!hackerSimulatorWindow.classList.contains('hidden')) {
                initBinaryBackground();
            }
        });
    </script>
</body>
</html>
